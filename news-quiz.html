<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+CiAgPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMWExYTFhIi8+CiAgPHJlY3QgeD0iNCIgeT0iNiIgd2lkdGg9IjI0IiBoZWlnaHQ9IjIiIGZpbGw9IndoaXRlIi8+CiAgPHJlY3QgeD0iNCIgeT0iMTAiIHdpZHRoPSIyNCIgaGVpZ2h0PSIxIiBmaWxsPSJ3aGl0ZSIgb3BhY2l0eT0iMC41Ii8+CiAgPHRleHQgeD0iMTYiIHk9IjI2IiBmb250LWZhbWlseT0iR2VvcmdpYSxzZXJpZiIgZm9udC1zaXplPSIxOCIgZm9udC13ZWlnaHQ9ImJvbGQiIAogICAgICAgIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5EPC90ZXh0Pgo8L3N2Zz4=">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Daily Dispatch Quiz</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,400&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1008;
    --paper: #f5f0e8;
    --cream: #ede8da;
    --red: #c0392b;
    --gold: #b8860b;
    --gold-light: #f0c040;
    --rule: #2c1f0e;
    --muted: #6b5f4e;
    --green: #1a6b3c;
    --blue: #1a3a6b;
    --bonus-bg: #0a0a1a;
    --bonus-gold: #ffd700;
    --bonus-glow: #ff8c00;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Source Serif 4', serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ‚îÄ MASTHEAD ‚îÄ‚îÄ‚îÄ */
  #masthead {
    background: var(--ink);
    color: var(--paper);
    text-align: center;
    padding: 10px 20px 14px;
    border-bottom: 4px double var(--gold);
    position: relative;
  }
  #masthead .dateline {
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--gold-light);
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  #masthead h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(28px, 6vw, 52px);
    font-weight: 900;
    letter-spacing: -1px;
    line-height: 1;
    color: var(--paper);
  }
  #masthead h1 span { color: var(--gold-light); }
  #masthead .city-label {
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    letter-spacing: 6px;
    text-transform: uppercase;
    color: var(--gold-light);
    opacity: 0.75;
    margin-bottom: 2px;
  }
  #masthead .tagline {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    letter-spacing: 3px;
    color: rgba(255,255,255,0.65);
    margin-top: 4px;
    text-transform: uppercase;
  }
  #admin-btn {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    background: none;
    border: 1px solid var(--muted);
    color: var(--muted);
    padding: 4px 10px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all .2s;
  }
  #admin-btn:hover { border-color: var(--gold-light); color: var(--gold-light); }

  /* ‚îÄ‚îÄ‚îÄ MAIN CONTAINER ‚îÄ‚îÄ‚îÄ */
  #app {
    max-width: 780px;
    margin: 0 auto;
    padding: 20px 16px 60px;
  }

  /* ‚îÄ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ */
  .screen { display: none; }
  .screen.active { display: block; }

  /* ‚îÄ‚îÄ‚îÄ REGISTER SCREEN ‚îÄ‚îÄ‚îÄ */
  #screen-register {
    text-align: center;
    padding: 40px 20px;
  }
  .edition-rule {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
    color: var(--muted);
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    letter-spacing: 2px;
  }
  .edition-rule::before, .edition-rule::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--rule);
  }
  #screen-register h2 {
    font-family: 'Playfair Display', serif;
    font-size: 32px;
    color: var(--ink);
    margin-bottom: 8px;
  }
  #screen-register p {
    color: var(--muted);
    font-style: italic;
    margin-bottom: 30px;
    font-size: 15px;
  }
  .points-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin: 24px 0;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }
  .points-card {
    background: var(--cream);
    border: 1px solid var(--rule);
    padding: 12px 8px;
    text-align: center;
  }
  .points-card .pts {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 700;
    color: var(--red);
  }
  .points-card .pts.bonus-pts { color: var(--gold); }
  .points-card .label {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    color: var(--muted);
    margin-top: 2px;
  }
  .input-group {
    display: flex;
    gap: 0;
    max-width: 420px;
    margin: 0 auto 16px;
    border: 2px solid var(--ink);
  }
  .input-group input {
    flex: 1;
    padding: 14px 16px;
    font-family: 'Source Serif 4', serif;
    font-size: 16px;
    background: white;
    border: none;
    outline: none;
    color: var(--ink);
  }
  .input-group input::placeholder { color: #aaa; font-style: italic; }
  .btn-primary {
    background: var(--ink);
    color: var(--paper);
    border: none;
    padding: 14px 24px;
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
    letter-spacing: 2px;
    cursor: pointer;
    text-transform: uppercase;
    transition: background .2s;
  }
  .btn-primary:hover { background: var(--red); }
  .btn-secondary {
    background: none;
    border: 2px solid var(--ink);
    color: var(--ink);
    padding: 10px 20px;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all .2s;
  }
  .btn-secondary:hover { background: var(--ink); color: var(--paper); }

  /* ‚îÄ‚îÄ‚îÄ QUIZ SCREEN ‚îÄ‚îÄ‚îÄ */
  #screen-quiz { padding: 10px 0; }
  .quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0 16px;
    border-bottom: 2px solid var(--ink);
    margin-bottom: 24px;
  }
  .quiz-header .player-name {
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    letter-spacing: 1px;
    color: var(--muted);
  }
  .quiz-header .player-name strong {
    color: var(--ink);
    font-size: 14px;
  }
  .score-display {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--red);
  }
  .score-display span {
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    color: var(--muted);
    vertical-align: middle;
    margin-right: 4px;
  }

  /* Progress tracker */
  .progress-track {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    align-items: center;
  }
  .progress-dot {
    width: 28px;
    height: 28px;
    border: 2px solid var(--rule);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    color: var(--muted);
    transition: all .3s;
    flex-shrink: 0;
  }
  .progress-dot.current { border-color: var(--ink); color: var(--ink); background: var(--cream); font-weight: 700; }
  .progress-dot.correct { background: var(--green); border-color: var(--green); color: white; }
  .progress-dot.wrong { background: var(--red); border-color: var(--red); color: white; }
  .progress-dot.bonus { border-color: var(--gold); color: var(--gold); }
  .progress-separator {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    color: var(--muted);
    margin: 0 4px;
  }

  /* Difficulty band */
  .difficulty-band {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    align-items: center;
  }
  .diff-label {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 3px 8px;
    border: 1px solid;
  }
  .diff-label.easy { color: var(--green); border-color: var(--green); }
  .diff-label.medium { color: var(--gold); border-color: var(--gold); }
  .diff-label.hard { color: var(--red); border-color: var(--red); }
  .diff-label.bonus { color: var(--gold); border-color: var(--gold); background: #fff8e0; }
  .pts-label {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    color: var(--muted);
  }

  /* Question card */
  .question-card {
    background: white;
    border: 2px solid var(--ink);
    padding: 28px 30px 24px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: 4px 4px 0 var(--ink);
    animation: slideIn .3s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .q-number {
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 10px;
  }
  .q-text {
    font-size: 19px;
    line-height: 1.5;
    color: var(--ink);
    font-weight: 400;
  }

  /* Answer options */
  .options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 20px;
  }
  .option-btn {
    background: var(--cream);
    border: 2px solid var(--rule);
    padding: 14px 16px;
    text-align: left;
    cursor: pointer;
    font-family: 'Source Serif 4', serif;
    font-size: 15px;
    color: var(--ink);
    transition: all .15s;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    line-height: 1.4;
  }
  .option-btn:hover:not(:disabled) { border-color: var(--ink); background: white; transform: translateY(-1px); }
  .option-btn .opt-letter {
    font-family: 'Courier Prime', monospace;
    font-weight: 700;
    font-size: 13px;
    color: var(--muted);
    flex-shrink: 0;
    margin-top: 1px;
  }
  .option-btn:disabled { cursor: default; transform: none; }
  .option-btn.correct { background: #d4edda; border-color: var(--green); }
  .option-btn.correct .opt-letter { color: var(--green); }
  .option-btn.wrong { background: #f8d7da; border-color: var(--red); }
  .option-btn.wrong .opt-letter { color: var(--red); }
  .option-btn.reveal-correct { background: #d4edda; border-color: var(--green); }

  /* Feedback */
  .feedback-box {
    margin-top: 16px;
    padding: 14px 18px;
    border-left: 4px solid;
    background: var(--cream);
    animation: slideIn .3s ease;
  }
  .feedback-box.correct { border-color: var(--green); }
  .feedback-box.wrong { border-color: var(--red); }
  .feedback-box .fb-headline {
    font-family: 'Courier Prime', monospace;
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }
  .feedback-box.correct .fb-headline { color: var(--green); }
  .feedback-box.wrong .fb-headline { color: var(--red); }
  .feedback-box .fb-text { font-size: 14px; color: var(--ink); line-height: 1.5; font-style: italic; }
  .feedback-box .pts-earned {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    margin-top: 6px;
  }
  .feedback-box.correct .pts-earned { color: var(--green); }

  .next-btn {
    display: block;
    width: 100%;
    margin-top: 16px;
    background: var(--ink);
    color: var(--paper);
    border: none;
    padding: 16px;
    font-family: 'Courier Prime', monospace;
    font-size: 14px;
    letter-spacing: 3px;
    cursor: pointer;
    text-transform: uppercase;
    transition: background .2s;
  }
  .next-btn:hover { background: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ INTERSTITIAL SCREEN ‚îÄ‚îÄ‚îÄ */
  #screen-interstitial {
    text-align: center;
    padding: 40px 20px;
    background: var(--ink);
    color: var(--paper);
    min-height: 60vh;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: -20px -16px;
    padding: 60px 40px;
    animation: fadeIn .5s ease;
  }
  #screen-interstitial.active { display: flex; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .interstitial-rule {
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold-light), transparent);
    margin: 20px 0;
    max-width: 500px;
  }
  #screen-interstitial .phase-label {
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--gold-light);
    margin-bottom: 12px;
  }
  #screen-interstitial h2 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(28px, 6vw, 48px);
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: 20px;
  }
  #interstitial-score {
    font-family: 'Playfair Display', serif;
    font-size: 64px;
    font-weight: 900;
    color: var(--gold-light);
    line-height: 1;
  }
  #screen-interstitial .score-subtext {
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 2px;
    margin-bottom: 30px;
  }
  #screen-interstitial p {
    font-style: italic;
    color: #c8b89a;
    max-width: 420px;
    line-height: 1.6;
    margin-bottom: 30px;
  }
  .pulse-text {
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* ‚îÄ‚îÄ‚îÄ BONUS SCREEN ‚îÄ‚îÄ‚îÄ */
  #screen-bonus {
    background: var(--bonus-bg);
    color: white;
    margin: -20px -16px;
    padding: 40px 30px;
    min-height: 70vh;
    animation: fadeIn .5s ease;
  }
  .bonus-header {
    text-align: center;
    margin-bottom: 30px;
    position: relative;
  }
  .bonus-badge {
    display: inline-block;
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--bonus-bg);
    background: var(--bonus-gold);
    padding: 6px 16px;
    text-transform: uppercase;
    margin-bottom: 12px;
    animation: shimmer 2s ease-in-out infinite;
  }
  @keyframes shimmer {
    0%, 100% { box-shadow: 0 0 10px var(--bonus-gold); }
    50% { box-shadow: 0 0 30px var(--bonus-glow), 0 0 60px var(--bonus-gold); }
  }
  .bonus-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(32px, 7vw, 56px);
    font-weight: 900;
    background: linear-gradient(135deg, var(--bonus-gold), var(--bonus-glow), var(--bonus-gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.1;
    margin-bottom: 6px;
  }
  .bonus-pts-label {
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
    letter-spacing: 2px;
    color: rgba(255,215,0,0.6);
  }
  .bonus-question-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,215,0,0.3);
    padding: 28px;
    margin: 24px 0;
    box-shadow: 0 0 40px rgba(255,165,0,0.1), inset 0 0 40px rgba(255,215,0,0.02);
  }
  .bonus-question-card .q-text {
    color: white;
    font-size: 20px;
    line-height: 1.55;
  }
  .bonus-options .option-btn {
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.2);
    color: white;
  }
  .bonus-options .option-btn .opt-letter { color: rgba(255,215,0,0.7); }
  .bonus-options .option-btn:hover:not(:disabled) {
    background: rgba(255,215,0,0.1);
    border-color: var(--bonus-gold);
  }
  .bonus-options .option-btn.correct {
    background: rgba(26,107,60,0.4);
    border-color: #4caf7d;
  }
  .bonus-options .option-btn.wrong {
    background: rgba(192,57,43,0.4);
    border-color: var(--red);
  }
  .bonus-options .option-btn.reveal-correct {
    background: rgba(26,107,60,0.4);
    border-color: #4caf7d;
  }
  .bonus-feedback {
    margin-top: 16px;
    padding: 16px 20px;
    border: 1px solid rgba(255,215,0,0.4);
    background: rgba(255,215,0,0.05);
  }
  .bonus-feedback .fb-headline {
    font-family: 'Courier Prime', monospace;
    font-size: 14px;
    letter-spacing: 2px;
    color: var(--bonus-gold);
    margin-bottom: 8px;
  }
  .bonus-feedback .fb-text { color: rgba(255,255,255,0.8); font-style: italic; font-size: 14px; line-height: 1.5; }
  .bonus-feedback .pts-earned { color: var(--bonus-gold); font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 700; margin-top: 8px; }
  .bonus-next-btn {
    display: block;
    width: 100%;
    margin-top: 20px;
    background: linear-gradient(135deg, #b8860b, #ffd700, #b8860b);
    color: var(--bonus-bg);
    border: none;
    padding: 18px;
    font-family: 'Courier Prime', monospace;
    font-size: 15px;
    letter-spacing: 3px;
    cursor: pointer;
    text-transform: uppercase;
    font-weight: 700;
    transition: opacity .2s;
  }
  .read-more-link {
    display: inline-block;
    margin-top: 10px;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--blue);
    text-decoration: none;
    border-bottom: 1px solid currentColor;
    opacity: 0.85;
    transition: opacity .15s;
  }
  .read-more-link:hover { opacity: 1; }
  .feedback-box.wrong .read-more-link { color: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ RESULTS SCREEN ‚îÄ‚îÄ‚îÄ */
  #screen-results { text-align: center; padding: 30px 10px; }
  #screen-results h2 {
    font-family: 'Playfair Display', serif;
    font-size: 36px;
    margin-bottom: 8px;
  }
  .results-banner {
    background: var(--ink);
    color: var(--paper);
    padding: 30px;
    margin: 20px 0;
    position: relative;
    overflow: hidden;
  }
  .results-banner::before {
    content: '‚òÖ';
    position: absolute;
    font-size: 200px;
    color: rgba(255,255,255,0.03);
    top: -40px;
    right: -20px;
  }
  .results-banner .today-score {
    font-family: 'Playfair Display', serif;
    font-size: 72px;
    font-weight: 900;
    color: var(--gold-light);
    line-height: 1;
  }
  .results-banner .today-label {
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
    margin-top: 4px;
  }
  .results-banner .all-time {
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
    color: #c8b89a;
    margin-top: 16px;
  }
  .results-banner .all-time strong { color: var(--paper); font-size: 16px; }
  .results-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 20px 0;
  }
  .stat-cell {
    background: var(--cream);
    border: 1px solid var(--rule);
    padding: 16px 8px;
    text-align: center;
  }
  .stat-cell .val {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 700;
    color: var(--ink);
  }
  .stat-cell .lbl {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    color: var(--muted);
    text-transform: uppercase;
    margin-top: 2px;
  }
  .results-breakdown {
    text-align: left;
    margin: 20px 0;
    border: 2px solid var(--ink);
  }
  .breakdown-header {
    background: var(--ink);
    color: var(--paper);
    padding: 10px 16px;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  .breakdown-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    border-bottom: 1px solid var(--cream);
    font-size: 14px;
  }
  .breakdown-row:last-child { border-bottom: none; }
  .breakdown-row .q-label { color: var(--muted); font-family: 'Courier Prime', monospace; font-size: 12px; }
  .breakdown-row .q-short { flex: 1; padding: 0 12px; color: var(--ink); }
  .breakdown-row .q-result { font-family: 'Courier Prime', monospace; font-size: 13px; font-weight: 700; }
  .breakdown-row .q-result.c { color: var(--green); }
  .breakdown-row .q-result.w { color: var(--red); }

  .dist-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 16px;
    border-bottom: 1px solid var(--border);
  }
  .dist-label {
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    font-weight: 700;
    width: 44px;
    flex-shrink: 0;
    color: var(--muted);
  }
  .dist-bar-wrap {
    flex: 1;
    background: #e8e0d5;
    border-radius: 3px;
    height: 14px;
    overflow: hidden;
  }
  .dist-bar {
    height: 100%;
    background: var(--green);
    border-radius: 3px;
    transition: width .4s ease;
    min-width: 2px;
  }
  .dist-pct {
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    font-weight: 700;
    width: 36px;
    text-align: right;
    color: var(--ink);
  }

  .result-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 24px; }

  /* ‚îÄ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ‚îÄ */
  #screen-leaderboard { padding: 20px 0; }
  .lb-tabs {
    display: flex;
    border-bottom: 2px solid var(--ink);
    margin-bottom: 20px;
  }
  .lb-tab {
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 10px 20px;
    cursor: pointer;
    color: var(--muted);
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all .2s;
  }
  .lb-tab.active { color: var(--ink); border-bottom-color: var(--red); font-weight: 700; }
  .lb-table { width: 100%; border-collapse: collapse; }
  .lb-table th {
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    text-align: left;
    padding: 8px 12px;
    border-bottom: 2px solid var(--ink);
    background: var(--cream);
  }
  .lb-table td {
    padding: 12px 12px;
    border-bottom: 1px solid var(--cream);
    font-size: 15px;
  }
  .lb-table tr.me td { background: rgba(192,57,43,0.08); }
  .lb-table tr.me td:first-child { border-left: 3px solid var(--red); }
  .lb-table .rank {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--muted);
    text-align: center;
  }
  .lb-table .rank.gold { color: #b8860b; }
  .lb-table .rank.silver { color: #888; }
  .lb-table .rank.bronze { color: #a0522d; }
  .lb-table .score-val {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--red);
  }
  .lb-back { margin-top: 20px; }

  /* ‚îÄ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ */
  #screen-admin { padding: 20px 0; }
  #screen-admin h2 {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--ink);
  }
  .admin-section {
    background: var(--cream);
    border: 1px solid var(--rule);
    padding: 20px;
    margin-bottom: 20px;
  }
  .admin-section h3 {
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 12px;
  }
  .url-input-area {
    width: 100%;
    min-height: 120px;
    padding: 12px;
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
    border: 2px solid var(--rule);
    background: white;
    color: var(--ink);
    resize: vertical;
  }
  .url-input-area:focus { outline: none; border-color: var(--ink); }
  .admin-actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
  .btn-generate {
    background: var(--blue);
    color: white;
    border: none;
    padding: 12px 24px;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    cursor: pointer;
    text-transform: uppercase;
    transition: background .2s;
  }
  .btn-generate:hover { background: #0a2a5a; }
  .btn-generate:disabled { background: var(--muted); cursor: wait; }
  .btn-danger {
    background: var(--red);
    color: white;
    border: none;
    padding: 12px 24px;
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    cursor: pointer;
    text-transform: uppercase;
  }

  /* Question review */
  .q-review-card {
    background: white;
    border: 1px solid var(--rule);
    padding: 16px;
    margin-bottom: 10px;
  }
  .q-review-card .q-meta {
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 8px;
    display: flex;
    gap: 12px;
  }
  .q-review-card .q-preview { font-size: 15px; color: var(--ink); }
  .q-review-card .answer-preview {
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    color: var(--green);
    margin-top: 6px;
  }
  .q-review-card .options-preview {
    font-family: 'Courier Prime', monospace;
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
  }

  .q-review-card input[type=text],
  .q-review-card textarea {
    width: 100%;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    color: var(--ink);
    background: var(--paper);
    border: 1px solid #ccc;
    border-radius: 2px;
    padding: 6px 8px;
    margin-top: 4px;
    box-sizing: border-box;
  }
  .q-review-card textarea { min-height: 56px; resize: vertical; }
  .q-review-card input[type=text]:focus,
  .q-review-card textarea:focus { outline: 2px solid var(--gold); border-color: var(--gold); }
  .q-options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
  .q-option-row { display: flex; align-items: center; gap: 6px; }
  .q-option-row label { font-family: 'Courier Prime', monospace; font-size: 12px; color: var(--muted); white-space: nowrap; }
  .q-option-row input[type=radio] { accent-color: var(--green); }
  .q-edit-label { font-family: 'Courier Prime', monospace; font-size: 11px; letter-spacing: 1px; color: var(--muted); margin-top: 10px; margin-bottom: 2px; }

  .q-review-card input[type=text],
  .q-review-card textarea {
    width: 100%;
    font-family: 'Source Serif 4', serif;
    font-size: 14px;
    color: var(--ink);
    background: var(--paper);
    border: 1px solid #ccc;
    border-radius: 2px;
    padding: 6px 8px;
    margin-top: 4px;
    box-sizing: border-box;
  }
  .q-review-card textarea { min-height: 56px; resize: vertical; }
  .q-review-card input[type=text]:focus,
  .q-review-card textarea:focus { outline: 2px solid var(--gold); border-color: var(--gold); }
  .q-options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
  .q-option-row { display: flex; align-items: center; gap: 6px; }
  .q-option-row label { font-family: 'Courier Prime', monospace; font-size: 12px; color: var(--muted); white-space: nowrap; }
  .q-option-row input[type=radio] { accent-color: var(--green); }
  .q-edit-label { font-family: 'Courier Prime', monospace; font-size: 11px; letter-spacing: 1px; color: var(--muted); margin-top: 10px; margin-bottom: 2px; }

  .status-msg {
    padding: 12px 16px;
    font-family: 'Courier Prime', monospace;
    font-size: 13px;
    margin: 12px 0;
    display: none;
  }
  .status-msg.show { display: block; }
  .status-msg.info { background: #e8f4fd; border-left: 4px solid var(--blue); color: var(--blue); }
  .status-msg.success { background: #d4edda; border-left: 4px solid var(--green); color: var(--green); }
  .status-msg.error { background: #f8d7da; border-left: 4px solid var(--red); color: var(--red); }

  /* Archive pill */
  .archive-pill {
    display: inline-block;
    font-family: 'Courier Prime', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    padding: 2px 8px;
    background: var(--cream);
    border: 1px solid var(--rule);
    color: var(--muted);
    margin-right: 4px;
    margin-bottom: 4px;
  }

  /* No quiz today */
  .no-quiz-card {
    text-align: center;
    padding: 60px 20px;
    background: var(--cream);
    border: 2px dashed var(--rule);
    margin: 20px 0;
  }
  .no-quiz-card .big-text {
    font-family: 'Playfair Display', serif;
    font-size: 48px;
    font-weight: 700;
    color: var(--rule);
    opacity: 0.3;
  }
  .no-quiz-card p {
    color: var(--muted);
    font-style: italic;
    margin-top: 12px;
  }

  /* Admin login */
  #admin-login-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  #admin-login-overlay.show { display: flex; }
  .login-box {
    background: white;
    border: 3px solid var(--ink);
    padding: 32px;
    max-width: 360px;
    width: 90%;
    box-shadow: 6px 6px 0 var(--ink);
  }
  .login-box h3 {
    font-family: 'Playfair Display', serif;
    font-size: 24px;
    margin-bottom: 20px;
  }
  .login-box input {
    display: block;
    width: 100%;
    padding: 12px;
    border: 2px solid var(--rule);
    font-family: 'Courier Prime', monospace;
    font-size: 14px;
    margin-bottom: 12px;
    outline: none;
  }
  .login-box input:focus { border-color: var(--ink); }
  .login-error {
    color: var(--red);
    font-family: 'Courier Prime', monospace;
    font-size: 12px;
    margin-top: 8px;
    display: none;
  }

  /* Responsive */
  @media (max-width: 520px) {
    .options-grid { grid-template-columns: 1fr; }
    .points-grid { grid-template-columns: repeat(2, 1fr); }
    .results-stats { grid-template-columns: repeat(2, 1fr); }
    .progress-track { flex-wrap: wrap; }
  }

  .spin {
    display: inline-block;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  .generating-overlay {
    text-align: center;
    padding: 40px;
    display: none;
  }
  .generating-overlay.show { display: block; }
  .generating-overlay .spinner { font-size: 32px; display: block; margin-bottom: 12px; }
  .generating-overlay p {
    font-family: 'Courier Prime', monospace;
    color: var(--muted);
    font-size: 13px;
    letter-spacing: 1px;
  }
</style>
</head>
<body>

<!-- MASTHEAD -->
<div id="masthead">
  <div class="dateline" id="today-dateline"></div>
  <div class="city-label">Baltimore</div>
  <h1>The Daily <span>Dispatch</span> Quiz</h1>
  <div class="tagline">Local News ¬∑ Daily Questions ¬∑ Community Knowledge</div>
  <button id="admin-btn" onclick="showAdminLogin()">Admin ‚ñ∏</button>
</div>

<!-- APP -->
<div id="app">

  <!-- REGISTER -->
  <div id="screen-register" class="screen active">
    <div class="edition-rule">Today's Edition</div>
    <h2>Know Your Community.</h2>
    <p>5 questions + a bonus drawn from today's local news ‚Äî updated daily by your editor.</p>
    <div class="points-grid">
      <div class="points-card"><div class="pts">10</div><div class="label">pts each<br>Q1‚Äì2 ¬∑ Starter</div></div>
      <div class="points-card"><div class="pts">20</div><div class="label">pts each<br>Q3‚Äì4 ¬∑ Feature</div></div>
      <div class="points-card"><div class="pts">30</div><div class="label">pts each<br>Q5 ¬∑ Scoop</div></div>
      <div class="points-card"><div class="pts bonus-pts">50</div><div class="label">pts each<br>Q6 ¬∑ Bonus</div></div>
    </div>
    <div class="edition-rule">Enter Your Byline</div>
    <div class="input-group">
      <input type="text" id="player-input" placeholder="Your name or pseudonym‚Ä¶" maxlength="30" />
      <button class="btn-primary" onclick="registerPlayer()">Begin ‚ñ∏</button>
    </div>
    <p style="font-size:13px; color:var(--muted); margin-top:8px;">Your name is saved across visits. Your score accumulates over time.</p>
    <div id="reg-error" style="color:var(--red);font-family:monospace,monospace;font-size:13px;margin-top:8px;display:none;"></div>
    <div style="margin-top:30px;">
      <button class="btn-secondary" onclick="showLeaderboard()">View Leaderboard ‚ñ∏</button>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="screen-quiz" class="screen">
    <div class="quiz-header">
      <div class="player-name">Byline: <strong id="quiz-player-name"></strong></div>
      <div class="score-display"><span>SCORE</span><span id="live-score">0</span></div>
      <div class="score-display" id="streak-display" style="display:none"><span>STREAK</span><span id="live-streak">üî• 1</span></div>
    </div>
    <div class="progress-track" id="progress-track"></div>
    <div id="question-area"></div>
  </div>

  <!-- INTERSTITIAL -->
  <div id="screen-interstitial" class="screen">
    <div class="phase-label">‚ú¶ Questions 1‚Äì5 Complete ‚ú¶</div>
    <h2>Round One<br>Complete.</h2>
    <div class="interstitial-rule"></div>
    <div id="interstitial-score">0</div>
    <div class="score-subtext">points earned so far</div>
    <p>You've answered the day's news ‚Äî from the straightforward to the substantive. But the hardest question still awaits.</p>
    <div class="interstitial-rule"></div>
    <div class="pulse-text" style="font-family:monospace,monospace;font-size:12px;letter-spacing:3px;color:var(--gold-light);margin-bottom:28px;">THE BONUS ROUND AWAITS</div>
    <p style="font-family:monospace,monospace;font-size:12px;color:var(--muted);margin-bottom:8px;">Taking you there now‚Ä¶</p>
    <div id="interstitial-countdown" style="font-family:'Playfair Display',serif;font-size:28px;color:var(--gold);margin-bottom:24px;">3</div>
  </div>

  <!-- BONUS -->
  <div id="screen-bonus" class="screen">
    <div class="bonus-header">
      <div class="bonus-badge">‚≠ê Bonus Round</div>
      <h2>The Final<br>Dispatch</h2>
      <div class="bonus-pts-label">50 POINTS ¬∑ ONE CHANCE ¬∑ NO HINTS</div>
    </div>
    <div id="bonus-area"></div>
  </div>

  <!-- RESULTS -->
  <div id="screen-results" class="screen">
    <div class="edition-rule">Final Score</div>
    <h2>That's a Wrap.</h2>
    <div class="results-banner">
      <div class="today-score" id="result-today-score">0</div>
      <div class="today-label">Today's Points</div>
      <div class="all-time">All-Time Total: <strong id="result-alltime-score">0</strong> pts</div>
    </div>
    <div class="results-stats">
      <div class="stat-cell"><div class="val" id="stat-correct">0</div><div class="lbl">Correct</div></div>
      <div class="stat-cell"><div class="val" id="stat-pct">0%</div><div class="lbl">Accuracy</div></div>
      <div class="stat-cell"><div class="val" id="stat-rank">#‚Äì</div><div class="lbl">Today's Rank</div></div>
    </div>
    <div class="results-breakdown" id="breakdown-table"></div>
    <div id="dist-table"></div>
    <div class="result-actions">
      <button class="btn-primary" onclick="showLeaderboard()">View Leaderboard ‚ñ∏</button>
      <button class="btn-secondary" onclick="showScreen('screen-register')">Play Again</button>
      <button class="btn-secondary" onclick="showCommunity()">üí¨ Community Board</button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="screen-leaderboard" class="screen">
    <div class="edition-rule">Standings</div>
    <div class="lb-tabs">
      <div class="lb-tab active" onclick="showLbTab('alltime',this)">All-Time</div>
      <div class="lb-tab" onclick="showLbTab('today',this)">Today</div>
    </div>
    <div id="lb-content"></div>
    <div class="lb-back">
      <button class="btn-secondary" onclick="showScreen('screen-register')">‚óÇ Back</button>
    </div>
  </div>

  <!-- COMMUNITY -->
  <div id="screen-community" class="screen">
    <div class="edition-rule">Community Board</div>
    <h2 style="margin-bottom:4px;">Player Discussion</h2>
    <p style="font-family:monospace,monospace;font-size:12px;color:var(--muted);margin-bottom:20px;">Post reactions, debate answers, tip off fellow players.</p>

    <!-- Post form -->
    <div style="background:white;border:1px solid var(--rule);padding:16px;margin-bottom:20px;">
      <div style="font-family:monospace,monospace;font-size:11px;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">YOUR PLAYER NAME</div>
      <input id="board-name" type="text" maxlength="40" placeholder="Enter your player name‚Ä¶" style="width:100%;font-family:serif,serif;font-size:14px;padding:8px;border:1px solid #ccc;margin-bottom:12px;box-sizing:border-box;">
      <div style="font-family:monospace,monospace;font-size:11px;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">YOUR MESSAGE</div>
      <textarea id="board-text" maxlength="500" placeholder="What's on your mind?" style="width:100%;font-family:serif,serif;font-size:14px;padding:8px;border:1px solid #ccc;min-height:80px;resize:vertical;box-sizing:border-box;"></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
        <span id="board-char-count" style="font-family:monospace,monospace;font-size:11px;color:var(--muted);">0 / 500</span>
        <button onclick="submitPost()" style="font-family:monospace;font-size:12px;letter-spacing:1px;padding:8px 20px;background:var(--ink);color:var(--paper);border:none;cursor:pointer;">POST ‚ñ∏</button>
      </div>
      <div id="board-status" style="font-family:monospace,monospace;font-size:12px;margin-top:8px;display:none;"></div>
    </div>

    <!-- Posts list -->
    <div id="posts-list"></div>

    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--rule);display:flex;gap:16px;flex-wrap:wrap;">
      <button class="btn-secondary" onclick="showScreen('screen-results')">‚óÇ Back to Results</button>
      <button class="btn-secondary" onclick="showContactForm()">‚úâ Message the Editor</button>
    </div>
  </div>

  <!-- CONTACT FORM -->
  <div id="screen-contact" class="screen">
    <div class="edition-rule">Private Message</div>
    <h2 style="margin-bottom:4px;">Message the Editor</h2>
    <p style="font-family:monospace,monospace;font-size:12px;color:var(--muted);margin-bottom:20px;">Your message goes directly to the editor. Your name and email are never shared.</p>

    <div style="background:white;border:1px solid var(--rule);padding:16px;">
      <div style="font-family:monospace,monospace;font-size:11px;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">YOUR PLAYER NAME</div>
      <input id="contact-name" type="text" maxlength="40" placeholder="Enter your player name‚Ä¶" style="width:100%;font-family:serif,serif;font-size:14px;padding:8px;border:1px solid #ccc;margin-bottom:12px;box-sizing:border-box;">
      <div style="font-family:monospace,monospace;font-size:11px;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">YOUR MESSAGE</div>
      <textarea id="contact-text" maxlength="1000" placeholder="What would you like to tell the editor?" style="width:100%;font-family:serif,serif;font-size:14px;padding:8px;border:1px solid #ccc;min-height:120px;resize:vertical;box-sizing:border-box;"></textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;">
        <button onclick="submitContact()" style="font-family:monospace;font-size:12px;letter-spacing:1px;padding:8px 20px;background:var(--ink);color:var(--paper);border:none;cursor:pointer;">SEND MESSAGE ‚ñ∏</button>
      </div>
      <div id="contact-status" style="font-family:monospace,monospace;font-size:12px;margin-top:8px;display:none;"></div>
    </div>

    <div style="margin-top:20px;">
      <button class="btn-secondary" onclick="showScreen('screen-community')">‚óÇ Back to Community</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="screen-admin" class="screen">
    <h2>Editor's Desk</h2>

    <div class="admin-section">
      <h3>Step 1 ‚Äî Paste News Article URLs</h3>
      <div id="freshness-notice" style="background:#fff8e0;border:1px solid var(--gold);padding:10px 14px;margin-bottom:12px;font-family:monospace,monospace;font-size:12px;color:#7a5f00;line-height:1.6;">
        <strong>‚è± Freshness filter is active.</strong> Claude will automatically skip any article published more than 24 hours ago and will not generate questions from stale content. Paste only links to <strong>today's</strong> articles for best results. If Claude skips articles, you'll see a warning below.
      </div>
      <p style="font-size:13px;color:var(--muted);margin-bottom:8px;">Enter your RSS feed or news website URLs once ‚Äî they'll be saved and pre-filled every time you open the admin panel. <strong>Do not paste specific article URLs here.</strong></p>
      <textarea class="url-input-area" id="urls-input" placeholder="Paste one RSS feed or news site URL per line‚Ä¶&#10;https://baltimorebrew.com/feed/&#10;https://marylandmatters.org/feed/&#10;‚Ä¶"></textarea>
      <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
        <button class="btn-secondary" style="font-size:11px;padding:7px 14px;" onclick="saveSites()">üíæ Save Sites</button>
        <span id="sites-saved-msg" style="font-family:monospace,monospace;font-size:11px;color:var(--green);display:none;">‚úì Sites saved!</span>
      </div>

      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--rule);">
        <h3 style="margin-bottom:4px;">Today's Hand-Picked Articles <span style="font-weight:400;font-size:12px;color:var(--muted);font-family:monospace;">(optional ‚Äî one-time use, not saved)</span></h3>
        <p style="font-size:13px;color:var(--muted);margin-bottom:8px;">Paste specific article URLs here to override the RSS feed entirely. Claude will use <em>only</em> these articles for question generation. <strong>Remember to clear this box before running the next day's quiz.</strong></p>
        <textarea class="url-input-area" id="article-urls-input" placeholder="Paste specific article URLs here, one per line‚Ä¶&#10;https://www.baltimoresun.com/2026/02/26/some-story/&#10;https://www.thebaltimorebanner.com/politics-power/‚Ä¶&#10;‚Ä¶" style="height:120px;"></textarea>
        <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
          <button class="btn-secondary" style="font-size:11px;padding:7px 14px;" onclick="saveArticleUrls()">üíæ Save Article URLs</button>
          <button class="btn-secondary" style="font-size:11px;padding:7px 14px;background:none;border-color:var(--red);color:var(--red);" onclick="clearArticleUrls()">‚úï Clear</button>
          <span id="article-urls-saved-msg" style="font-family:monospace,monospace;font-size:11px;color:var(--green);display:none;">‚úì Saved!</span>
        </div>
      </div>

      <details style="margin-top:14px;">
        <summary style="font-family:monospace,monospace;font-size:12px;letter-spacing:1px;cursor:pointer;color:var(--muted);">‚ñ∏ Paywalled or JS-only site? Paste article text directly instead</summary>
        <div style="margin-top:10px;">
          <p style="font-size:13px;color:var(--muted);margin-bottom:6px;">If a site blocks automated fetching, copy-paste the article text here (one article after another, separated by a blank line). The URL box above can be left empty.</p>
          <textarea class="url-input-area" id="manual-text-input" placeholder="Paste full article text here‚Ä¶&#10;&#10;(Date: February 18, 2026 ‚Äî include the date so Claude can verify freshness)" style="min-height:160px;"></textarea>
        </div>
      </details>

      <div class="admin-actions" style="flex-wrap:wrap;gap:10px;">
        <button class="btn-secondary" id="refresh-btn" onclick="refreshRSS()" style="font-size:12px;padding:8px 16px;">‚Üª Refresh Articles</button>
        <button class="btn-generate" id="gen-btn" onclick="generateQuestions()">‚öô Generate Questions</button>
      </div>
      <div id="rss-status" style="font-family:monospace,monospace;font-size:11px;color:var(--muted);margin-top:8px;"></div>
      <div class="status-msg" id="gen-status" style="white-space:pre-wrap;"></div>
      <div class="generating-overlay" id="gen-overlay">
        <span class="spinner spin">‚öô</span>
        <p id="gen-progress-text">Fetching articles‚Ä¶</p>
      </div>

      <!-- Raw API response debug panel -->
      <div id="raw-debug" style="display:none;margin-top:16px;background:#f0f0f0;border:1px solid #ccc;padding:12px;">
        <div style="font-family:monospace,monospace;font-size:11px;letter-spacing:1px;color:var(--muted);margin-bottom:6px;">‚ñæ RAW CLAUDE RESPONSE (for debugging)</div>
        <pre id="raw-debug-text" style="font-family:monospace,monospace;font-size:11px;white-space:pre-wrap;word-break:break-all;max-height:200px;overflow:auto;color:#333;"></pre>
      </div>
    </div>

    <div class="admin-section" id="preview-section" style="display:none;">
      <h3>Step 2 ‚Äî Review Questions</h3>
      <div id="q-preview-list"></div>
      <div class="admin-actions">
        <button class="btn-generate" onclick="publishQuestions()">‚úì Publish Today's Quiz</button>
        <button class="btn-secondary" onclick="discardDraft()">‚úï Discard Draft</button>
      </div>
    </div>

    <div class="admin-section">
      <h3>Question Archive</h3>
      <p style="font-size:13px;color:var(--muted);margin-bottom:10px;">Questions in the archive will not be regenerated. <strong id="archive-count">0</strong> questions archived.</p>
      <div id="archive-preview"></div>
      <div class="admin-actions" style="margin-top:12px;">
        <button class="btn-danger" onclick="clearArchive()">Clear Archive</button>
        <button class="btn-danger" onclick="resetDailyScores()">Reset Daily Scores</button>
      </div>
    </div>

    <div class="admin-section">
      <h3>Today's Published Quiz</h3>
      <div id="published-preview">
        <p style="font-size:13px;color:var(--muted);font-style:italic;">No quiz published today.</p>
      </div>
    </div>

    <div class="admin-section" style="margin-top:20px;">
      <h3>Community Posts <span id="admin-posts-badge" style="display:none;background:var(--red,#c0392b);color:white;font-size:11px;padding:2px 7px;border-radius:10px;font-family:monospace;margin-left:6px;"></span></h3>
      <div id="admin-posts-list">
        <p style="font-family:monospace;font-size:12px;color:var(--muted);">Loading posts‚Ä¶</p>
      </div>
    </div>

    <div style="margin-top:20px;">
      <button class="btn-secondary" onclick="showScreen('screen-register')">‚óÇ Exit Admin</button>
    </div>
  </div>

</div><!-- #app -->

<!-- ADMIN LOGIN OVERLAY -->
<div id="admin-login-overlay">
  <div class="login-box">
    <h3>Editor Access</h3>
    <input type="password" id="admin-pw-input" placeholder="Password" onkeydown="if(event.key==='Enter')checkAdminPw()" />
    <div style="display:flex;gap:10px;">
      <button class="btn-primary" onclick="checkAdminPw()">Enter ‚ñ∏</button>
      <button class="btn-secondary" onclick="document.getElementById('admin-login-overlay').classList.remove('show')">Cancel</button>
    </div>
    <div class="login-error" id="login-error">Incorrect password.</div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_PASSWORD = 'Sco0p$1#'; // ‚Üê Change this
const CLAUDE_MODEL = 'claude-sonnet-4-20250514';

// Point values
const POINTS = { easy: 10, medium: 20, hard: 30, bonus: 50 };

function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  playerName: '',
  currentQ: 0,
  sessionScore: 0,
  streak: 0,
  answers: [],
  phase: 'regular', // regular | bonus | done
  todayKey: todayStr()
};

// ‚îÄ‚îÄ‚îÄ Storage helpers (localStorage fallback) ‚îÄ‚îÄ‚îÄ
function lsGet(key) {
  try { return JSON.parse(localStorage.getItem(key)); } catch(e) { return null; }
}
function lsSet(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ Players ‚îÄ‚îÄ‚îÄ
function getPlayers() { return lsGet('dnq_players') || {}; }
function savePlayers(p) { lsSet('dnq_players', p); }

function getOrCreatePlayer(name) {
  const players = getPlayers();
  const key = name.toLowerCase().trim();
  if (!players[key]) {
    players[key] = { displayName: name, allTime: 0, dailyScores: {}, streak: 0, lastPlayed: '' };
  }
  savePlayers(players);
  return players[key];
}

function updatePlayerScore(name, todayScore) {
  const players = getPlayers();
  const key = name.toLowerCase().trim();
  if (!players[key]) return;
  players[key].allTime = (players[key].allTime || 0) + todayScore;
  if (!players[key].dailyScores) players[key].dailyScores = {};
  players[key].dailyScores[state.todayKey] = (players[key].dailyScores[state.todayKey] || 0) + todayScore;
  savePlayers(players);
}

// ‚îÄ‚îÄ‚îÄ Quiz data ‚îÄ‚îÄ‚îÄ
function getTodayQuiz() { return lsGet('dnq_quiz_' + todayStr()); }
function saveTodayQuiz(q) { lsSet('dnq_quiz_' + todayStr(), q); }
function getDraftQuiz() { return lsGet('dnq_draft'); }
function saveDraftQuiz(q) { lsSet('dnq_draft', q); }
function clearDraftQuiz() { localStorage.removeItem('dnq_draft'); }

// ‚îÄ‚îÄ‚îÄ Archive ‚îÄ‚îÄ‚îÄ
function getArchive() { return lsGet('dnq_archive') || []; }
function addToArchive(questions) {
  const archive = getArchive();
  questions.forEach(q => { if (!archive.includes(q.question)) archive.push(q.question); });
  lsSet('dnq_archive', archive);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('today-dateline').textContent =
    new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }).toUpperCase();

  // Restore player from last session
  const saved = lsGet('dnq_current_player');
  if (saved) {
    document.getElementById('player-input').value = saved;
  }

  // ‚îÄ‚îÄ Load sample quiz for demo purposes if none exists today ‚îÄ‚îÄ
  if (!getTodayQuiz()) {
    const sample = {
      questions: [
        {
          question: "A major water main break disrupted traffic in which Baltimore neighborhood on Thursday morning?",
          options: ["Federal Hill", "Hampden", "Canton", "Fells Point"],
          correctIndex: 2,
          explanation: "A 16-inch water main ruptured on Boston Street in Canton, causing significant flooding and closing several blocks to traffic Thursday morning.",
          difficulty: "easy",
          sourceUrl: "https://baltimorebrew.com"
        },
        {
          question: "Baltimore City Schools announced it would close which school due to a heating system failure this week?",
          options: ["Francis Scott Key Elementary", "Govans Elementary", "Harlem Park Elementary", "Cherry Hill Elementary"],
          correctIndex: 1,
          explanation: "Govans Elementary was closed Thursday after its boiler failed, displacing roughly 280 students who were relocated to a nearby recreation center.",
          difficulty: "easy",
          sourceUrl: "https://www.wbal.com"
        },
        {
          question: "The Maryland General Assembly this week took up a bill dealing with which transportation issue?",
          options: ["Speed cameras on I-695", "Red light cameras in school zones", "Toll increases on the Bay Bridge", "Electric scooter regulations in Baltimore City"],
          correctIndex: 0,
          explanation: "Legislators debated expanding the state's speed camera program to include sections of the Baltimore Beltway near active work zones.",
          difficulty: "easy",
          sourceUrl: "https://marylandmatters.org"
        },
        {
          question: "A Baltimore City Council committee advanced legislation this week aimed at addressing what issue?",
          options: ["Short-term rental regulations", "Vacant property tax penalties", "Noise ordinance enforcement", "Sidewalk repair liability"],
          correctIndex: 1,
          explanation: "The Housing and Community Development Committee voted to advance a bill that would double tax penalties on owners of long-vacant properties.",
          difficulty: "easy",
          sourceUrl: "https://baltimorebrew.com"
        },
        {
          question: "Baltimore Police Commissioner Richard Worley announced a new deployment strategy this week focused on which district?",
          options: ["Northern District", "Eastern District", "Western District", "Southern District"],
          correctIndex: 2,
          explanation: "Commissioner Worley announced a surge of approximately 40 additional officers into the Western District following a spike in carjackings over the past three weeks.",
          difficulty: "medium",
          sourceUrl: "https://www.wbaltv.com"
        },
        {
          question: "Maryland Governor Wes Moore signed an executive order Thursday directing state agencies to do what?",
          options: ["Freeze non-essential hiring through June", "Accelerate broadband permitting in rural counties", "Require diversity audits of all state contractors", "Expand Medicaid coverage for dental care"],
          correctIndex: 1,
          explanation: "Governor Moore signed an order directing the Maryland Department of Transportation and related agencies to cut permitting timelines for broadband infrastructure in the state's 10 least-connected counties.",
          difficulty: "medium",
          sourceUrl: "https://marylandmatters.org"
        },
        {
          question: "The Baltimore Development Corporation voted this week to approve a tax increment financing deal for a project in which area?",
          options: ["Port Covington", "Mondawmin", "Oldtown Mall site", "Cherry Hill"],
          correctIndex: 2,
          explanation: "The BDC board voted 6-1 to approve a $34 million TIF package to support a mixed-use redevelopment of the long-vacant Oldtown Mall site on Gay Street.",
          difficulty: "medium",
          sourceUrl: "https://thedailyrecord.com"
        },
        {
          question: "What was the exact dollar amount Baltimore City requested in state aid for school infrastructure repairs in Thursday's Board of Estimates meeting?",
          options: ["$112.4 million", "$87.6 million", "$143.2 million", "$98.8 million"],
          correctIndex: 3,
          explanation: "City budget officials requested $98.8 million in emergency state infrastructure funds, citing deteriorating HVAC and electrical systems across 34 school buildings.",
          difficulty: "hard",
          sourceUrl: "https://baltimorebrew.com"
        },
        {
          question: "By what vote margin did the Maryland Senate Education Committee approve the school funding amendment on Wednesday?",
          options: ["7-4", "8-3", "6-5", "9-2"],
          correctIndex: 0,
          explanation: "The committee approved the Kirwan funding amendment 7-4 after two hours of testimony, sending it to the full Senate floor for a vote expected next week.",
          difficulty: "hard",
          sourceUrl: "https://marylandmatters.org"
        },
        {
          question: "A federal indictment unsealed Thursday charged a Baltimore County man with defrauding the Small Business Administration of exactly how much money?",
          options: ["$2.1 million", "$4.7 million", "$3.3 million", "$1.9 million"],
          correctIndex: 2,
          explanation: "Federal prosecutors charged 44-year-old Randall T. Givens of Catonsville with wire fraud and money laundering after he allegedly submitted 11 fraudulent COVID-era SBA loan applications totaling $3.3 million.",
          difficulty: "hard",
          sourceUrl: "https://thedailyrecord.com"
        },
        {
          question: "According to Thursday's Board of Estimates agenda, what was the precise per-square-foot lease rate the city agreed to pay for temporary office space at 100 S. Charles Street?",
          options: ["$26.50", "$31.75", "$28.40", "$33.20"],
          correctIndex: 2,
          explanation: "The lease agreement approved Thursday set a rate of $28.40 per square foot annually for 14,200 square feet of swing space at 100 S. Charles Street, to house displaced Housing Authority staff during the Poe Homes redevelopment.",
          difficulty: "bonus",
          sourceUrl: "https://baltimorebrew.com"
        }
      ]
    };
    saveTodayQuiz(sample);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCREEN MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REGISTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function registerPlayer() {
  const name = document.getElementById('player-input').value.trim();
  const errEl = document.getElementById('reg-error');
  if (!name) { errEl.textContent = 'Please enter a name or pseudonym.'; errEl.style.display='block'; return; }
  errEl.style.display='none';
  lsSet('dnq_player_name', name); // save for community board pre-fill

  state.playerName = name;
  lsSet('dnq_current_player', name);
  getOrCreatePlayer(name);

  // // Server is authoritative ‚Äî always fetch today's quiz from server first
  let quiz = null;
  try {
    const serverRes = await fetch('/api/quiz?date=' + todayStr());
    const serverData = await serverRes.json();
    if (serverData.quiz && serverData.quiz.questions && serverData.quiz.questions.length >= 6) {
      quiz = serverData.quiz;
      saveTodayQuiz(quiz); // update local cache
    }
  } catch(e) { /* fall back to localStorage */ }
  // Fall back to localStorage only if server has nothing
  if (!quiz || !quiz.questions || quiz.questions.length < 6) {
    quiz = getTodayQuiz();
  }
  if (!quiz || !quiz.questions || quiz.questions.length < 6) {
    // Show no-quiz state
    showScreen('screen-quiz');
    document.getElementById('quiz-player-name').textContent = name;
    document.getElementById('live-score').textContent = '0';
    document.getElementById('question-area').innerHTML = `
      <div class="no-quiz-card">
        <div class="big-text">üì∞</div>
        <p>No quiz has been published for today yet. Check back soon!</p>
        <p style="margin-top:16px;"><button class="btn-secondary" onclick="showScreen('screen-register')">‚óÇ Back</button></p>
      </div>`;
    buildProgressTrack([]);
    return;
  }

  // Check if already played today
  const players = getPlayers();
  const pkey = name.toLowerCase().trim();
  if (players[pkey] && players[pkey].dailyScores && players[pkey].dailyScores[state.todayKey] !== undefined) {
    if (!confirm(`You already played today's quiz (${players[pkey].dailyScores[state.todayKey]} pts). Play again? Your score won't be added twice.`)) {
      showLeaderboard();
      return;
    }
  }

  startQuiz(quiz);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUIZ FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let quizQuestions = [];
let quizAnswered = false;

function startQuiz(quiz) {
  quizQuestions = quiz.questions;
  state.currentQ = 0;
  state.sessionScore = 0;
  state.streak = 0;
  state.answers = [];
  state.phase = 'regular';

  document.getElementById('quiz-player-name').textContent = state.playerName;
  document.getElementById('live-score').textContent = '0';
  buildProgressTrack(quizQuestions);
  showScreen('screen-quiz');
  renderQuestion();
}

function buildProgressTrack(qs) {
  const track = document.getElementById('progress-track');
  if (!qs.length) { track.innerHTML = ''; return; }
  let html = '';
  for (let i = 0; i < 5; i++) {
    const cls = i === 0 ? 'current' : '';
    html += `<div class="progress-dot ${cls}" id="pd-${i}">${i+1}</div>`;
    if (i === 2) html += `<span class="progress-separator">¬∑</span>`;
  }
  html += `<span class="progress-separator">‚óÜ</span>`;
  html += `<div class="progress-dot bonus" id="pd-5">‚òÖ</div>`;
  track.innerHTML = html;
}

function getDifficultyLabel(idx) {
  if (idx < 4) return { label: 'Starter', cls: 'easy', pts: 10 };
  if (idx < 7) return { label: 'Feature', cls: 'medium', pts: 20 };
  return { label: 'Scoop', cls: 'hard', pts: 30 };
}

function renderQuestion() {
  const q = quizQuestions[state.currentQ];
  const diff = getDifficultyLabel(state.currentQ);
  quizAnswered = false;

  const optLetters = ['A','B','C','D'];
  let optHtml = '';
  q.options.forEach((opt, i) => {
    optHtml += `<button class="option-btn" onclick="selectAnswer(${i})" id="opt-${i}">
      <span class="opt-letter">${optLetters[i]}</span>
      <span>${escHtml(opt)}</span>
    </button>`;
  });

  document.getElementById('question-area').innerHTML = `
    <div class="difficulty-band">
      <span class="diff-label ${diff.cls}">${diff.label}</span>
      <span class="pts-label">+${diff.pts} pts if correct</span>
    </div>
    <div class="question-card">
      <div class="q-number">Question ${state.currentQ + 1} of 5</div>
      <div class="q-text">${escHtml(q.question)}</div>
      <div class="options-grid">${optHtml}</div>
      <div id="feedback-area"></div>
    </div>
  `;
}

function selectAnswer(idx) {
  if (quizAnswered) return;
  quizAnswered = true;

  const q = quizQuestions[state.currentQ];
  const correct = idx === q.correctIndex;
  const diff = getDifficultyLabel(state.currentQ);
  const pts = correct ? diff.pts : 0;

  state.sessionScore += pts;
  state.answers.push({ qIdx: state.currentQ, chosen: idx, correct, pts });
  document.getElementById('live-score').textContent = state.sessionScore;

  // Update streak
  if (correct) {
    state.streak++;
  } else {
    state.streak = 0;
  }
  const streakEl = document.getElementById('streak-display');
  const streakVal = document.getElementById('live-streak');
  if (state.streak >= 2) {
    streakEl.style.display = '';
    streakVal.textContent = 'üî• ' + state.streak;
  } else {
    streakEl.style.display = 'none';
  }

  // Update progress dot
  const pd = document.getElementById('pd-' + state.currentQ);
  if (pd) { pd.className = 'progress-dot ' + (correct ? 'correct' : 'wrong'); }

  // Style options
  for (let i = 0; i < q.options.length; i++) {
    const btn = document.getElementById('opt-' + i);
    if (!btn) continue;
    btn.disabled = true;
    if (i === q.correctIndex) btn.classList.add('reveal-correct');
    if (i === idx && !correct) btn.classList.add('wrong');
    if (i === idx && correct) { btn.classList.remove('reveal-correct'); btn.classList.add('correct'); }
  }

  // Feedback
  const fb = document.getElementById('feedback-area');
  if (fb) {
    const sourceLink = q.sourceUrl
      ? `<a href="${escHtml(q.sourceUrl)}" target="_blank" rel="noopener" class="read-more-link">Read the full story ‚Üí</a>`
      : '';
    fb.innerHTML = `
      <div class="feedback-box ${correct ? 'correct' : 'wrong'}">
        <div class="fb-headline">${correct ? '‚úì CORRECT' : '‚úó INCORRECT'}</div>
        <div class="fb-text">${escHtml(q.explanation || (correct ? 'Well done!' : 'Better luck next time.'))}</div>
        ${correct ? `<div class="pts-earned">+${pts} pts</div>` : ''}
        ${sourceLink}
      </div>
      <button class="next-btn" onclick="advanceQuestion()">
        ${state.currentQ < 4 ? 'Next Question ‚ñ∏' : 'See Results Tally ‚ñ∏'}
      </button>
      <div id="comment-badge" style="margin-top:8px;text-align:center;font-family:monospace;font-size:11px;color:var(--muted);"></div>
    `;
    // Async: populate comment count badge
    getWeeklyCommentCount().then(count => {
      const badge = document.getElementById('comment-badge');
      if (!badge) return;
      if (count > 0) {
        badge.innerHTML = `<a href="#" onclick="showCommunity();return false;" style="color:var(--muted);text-decoration:underline;">üí¨ ${count} comment${count === 1 ? '' : 's'} this week</a>`;
      } else {
        badge.innerHTML = `<a href="#" onclick="showCommunity();return false;" style="color:var(--muted);text-decoration:underline;">üí¨ Be the first to comment</a>`;
      }
    });
  }
}

function advanceQuestion() {
  state.currentQ++;
  const regularCount = Math.min(quizQuestions.length - 1, 5);
  if (state.currentQ < regularCount) {
    // Update progress dot
    const pd = document.getElementById('pd-' + state.currentQ);
    if (pd) pd.className = 'progress-dot current';
    renderQuestion();
  } else {
    showInterstitial();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTERSTITIAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showInterstitial() {
  document.getElementById('interstitial-score').textContent = state.sessionScore;
  showScreen('screen-interstitial');
  // Auto-advance to bonus after 3-second countdown
  let count = 3;
  const cdEl = document.getElementById('interstitial-countdown');
  const timer = setInterval(() => {
    count--;
    if (count > 0) {
      cdEl.textContent = count;
    } else {
      clearInterval(timer);
      startBonusRound();
    }
  }, 1000);
}

function startBonusRound() {
  showScreen('screen-bonus');
  renderBonus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BONUS ROUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let bonusAnswered = false;

function renderBonus() {
  const q = quizQuestions[5]; // bonus is index 5
  bonusAnswered = false;
  const optLetters = ['A','B','C','D'];
  let optHtml = '';
  q.options.forEach((opt, i) => {
    optHtml += `<button class="option-btn" onclick="selectBonus(${i})" id="bopt-${i}">
      <span class="opt-letter">${optLetters[i]}</span>
      <span>${escHtml(opt)}</span>
    </button>`;
  });

  document.getElementById('bonus-area').innerHTML = `
    <div class="bonus-question-card">
      <div class="q-number" style="color:rgba(255,215,0,0.5);">Bonus Question ¬∑ 50 Points</div>
      <div class="q-text">${escHtml(q.question)}</div>
    </div>
    <div class="bonus-options options-grid">${optHtml}</div>
    <div id="bonus-feedback-area"></div>
  `;
}

function selectBonus(idx) {
  if (bonusAnswered) return;
  bonusAnswered = true;

  const q = quizQuestions[5];
  const correct = idx === q.correctIndex;
  const pts = correct ? 50 : 0;

  state.sessionScore += pts;
  state.answers.push({ qIdx: 5, chosen: idx, correct, pts });

  // Style
  for (let i = 0; i < q.options.length; i++) {
    const btn = document.getElementById('bopt-' + i);
    if (!btn) continue;
    btn.disabled = true;
    if (i === q.correctIndex) btn.classList.add('reveal-correct');
    if (i === idx && !correct) btn.classList.add('wrong');
    if (i === idx && correct) { btn.classList.remove('reveal-correct'); btn.classList.add('correct'); }
  }

  const fb = document.getElementById('bonus-feedback-area');
  if (fb) {
    const sourceLink = q.sourceUrl
      ? `<a href="${escHtml(q.sourceUrl)}" target="_blank" rel="noopener" class="read-more-link" style="color:var(--bonus-gold);">Read the full story ‚Üí</a>`
      : '';
    fb.innerHTML = `
      <div class="bonus-feedback">
        <div class="fb-headline">${correct ? '‚≠ê CORRECT ‚Äî EXCEPTIONAL!' : '‚úó NOT QUITE'}</div>
        <div class="fb-text">${escHtml(q.explanation || '')}</div>
        ${correct ? `<div class="pts-earned">+50 pts</div>` : ''}
        ${sourceLink}
      </div>
      <button class="bonus-next-btn" onclick="finishQuiz()">View Final Results ‚ñ∏</button>
    `;
  }

  // Update bonus progress dot
  const pd = document.getElementById('pd-5');
  if (pd) pd.className = 'progress-dot bonus ' + (correct ? 'correct' : 'wrong');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function finishQuiz() {
  // Save scores locally
  updatePlayerScore(state.playerName, state.sessionScore);

  // Submit score to server for shared leaderboard
  fetch('/api/scores', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      playerName: state.playerName,
      date: state.todayKey,
      score: state.sessionScore
    })
  }).catch(() => {});

  // POST this player's answers to server for community distribution
  fetch('/api/answers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      date: state.todayKey,
      answers: state.answers.map(a => ({ qIdx: a.qIdx, correct: a.correct }))
    })
  }).catch(() => {}); // fire and forget

  // Compute stats
  const total = state.answers.length;
  const correct = state.answers.filter(a => a.correct).length;
  const pct = total ? Math.round(correct/total*100) : 0;

  // Get rank
  const players = getPlayers();
  const todayScores = Object.values(players)
    .map(p => (p.dailyScores || {})[state.todayKey] || 0)
    .sort((a,b) => b-a);
  const myScore = (players[state.playerName.toLowerCase().trim()]?.dailyScores || {})[state.todayKey] || state.sessionScore;
  const rank = todayScores.findIndex(s => s <= myScore) + 1;

  // All-time
  const allTime = players[state.playerName.toLowerCase().trim()]?.allTime || state.sessionScore;

  document.getElementById('result-today-score').textContent = state.sessionScore;
  document.getElementById('result-alltime-score').textContent = allTime;
  document.getElementById('stat-correct').textContent = correct;
  document.getElementById('stat-pct').textContent = pct + '%';
  document.getElementById('stat-rank').textContent = '#' + rank;

  // Breakdown
  let brows = `<div class="breakdown-header">Question Breakdown</div>`;
  state.answers.forEach(a => {
    const q = quizQuestions[a.qIdx];
    const isBonus = a.qIdx === 5;
    brows += `<div class="breakdown-row">
      <span class="q-label">${isBonus ? 'BONUS' : ('Q' + (a.qIdx+1))}</span>
      <span class="q-short">${escHtml(q.question.slice(0, 55))}${q.question.length > 55 ? '‚Ä¶' : ''}</span>
      <span class="q-result ${a.correct ? 'c' : 'w'}">${a.correct ? '+'+a.pts : '0'}</span>
    </div>`;
  });
  document.getElementById('breakdown-table').innerHTML = brows;
  showScreen('screen-results');
  document.getElementById('dist-table').innerHTML = '<div class="breakdown-header" style="margin-top:24px;">How Others Did</div><div style="font-size:13px;color:var(--muted);padding:8px 0;">Loading‚Ä¶</div>';

  // Fetch community distribution from server
  fetch('/api/answers?date=' + state.todayKey)
    .then(r => r.json())
    .then(dist2 => {
      const totalPlayers = dist2['q0'] ? (dist2['q0'].correct + dist2['q0'].wrong) : 0;
      let distHtml = '<div class="breakdown-header" style="margin-top:24px;">How Others Did</div>';
      if (totalPlayers < 2) {
        distHtml += '<div style="font-size:13px;color:var(--muted);padding:8px 0;">Be the first! Distribution appears once more players have finished.</div>';
      } else {
        distHtml += `<div style="font-size:12px;color:var(--muted);padding:4px 16px 8px;">Based on ${totalPlayers} player${totalPlayers === 1 ? '' : 's'} today</div>`;
        quizQuestions.forEach((q, i) => {
          const k = 'q' + i;
          const d = dist2[k] || { correct: 0, wrong: 0 };
          const total = d.correct + d.wrong;
          const pct = total ? Math.round(d.correct / total * 100) : 0;
          const isBonus = i === 5;
          const label = isBonus ? 'BONUS' : ('Q' + (i + 1));
          distHtml += `<div class="dist-row">
            <span class="dist-label">${label}</span>
            <div class="dist-bar-wrap"><div class="dist-bar" style="width:${pct}%"></div></div>
            <span class="dist-pct">${pct}%</span>
          </div>`;
        });
      }
      document.getElementById('dist-table').innerHTML = distHtml;
    })
    .catch(() => {
      document.getElementById('dist-table').innerHTML = '';
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEADERBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentLbTab = 'alltime';

function showLeaderboard() {
  currentLbTab = 'alltime';
  document.querySelectorAll('.lb-tab').forEach((t,i) => t.classList.toggle('active', i===0));
  renderLeaderboard('alltime');
  showScreen('screen-leaderboard');
}

function showLbTab(tab, el) {
  currentLbTab = tab;
  document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderLeaderboard(tab);
}

async function renderLeaderboard(tab) {
  const el = document.getElementById('lb-body');
  if (el) el.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--muted);padding:20px;">Loading‚Ä¶</td></tr>';

  // Merge local scores with server scores
  const localPlayers = getPlayers();
  let players = { ...localPlayers };
  try {
    const res = await fetch('/api/scores');
    const data = await res.json();
    if (data.scores) {
      // Merge server scores ‚Äî server wins for allTime, merge dailyScores
      for (const [key, p] of Object.entries(data.scores)) {
        if (!players[key]) {
          players[key] = p;
        } else {
          // Merge daily scores, recompute allTime
          players[key].dailyScores = { ...players[key].dailyScores, ...p.dailyScores };
          players[key].allTime = Object.values(players[key].dailyScores).reduce((a,b) => a+b, 0);
        }
      }
    }
  } catch(e) { /* use local only */ }

  let rows = Object.entries(players).map(([key, p]) => ({
    name: p.displayName || key,
    score: tab === 'alltime' ? (p.allTime || 0) : ((p.dailyScores || {})[state.todayKey] || 0),
    isMe: key === state.playerName.toLowerCase().trim()
  }));
  rows.sort((a,b) => b.score - a.score);
  if (tab === 'today') rows = rows.filter(r => r.score > 0);

  let html = `<table class="lb-table"><thead><tr>
    <th style="width:40px">Rank</th>
    <th>Name</th>
    <th style="text-align:right">Score</th>
  </tr></thead><tbody>`;

  if (!rows.length) {
    html += `<tr><td colspan="3" style="text-align:center;color:var(--muted);font-style:italic;padding:30px;">No scores yet today.</td></tr>`;
  }
  rows.forEach((r, i) => {
    const rankCls = i===0 ? 'gold' : i===1 ? 'silver' : i===2 ? 'bronze' : '';
    html += `<tr class="${r.isMe ? 'me' : ''}">
      <td><div class="rank ${rankCls}">${i+1}</div></td>
      <td style="font-weight:${r.isMe?'700':'400'}">${escHtml(r.name)}${r.isMe ? ' <span style="color:var(--red);font-family:\'Courier Prime\',monospace;font-size:11px;">‚óÄ YOU</span>' : ''}</td>
      <td style="text-align:right"><span class="score-val">${r.score}</span></td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('lb-content').innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAdminLogin() {
  document.getElementById('admin-login-overlay').classList.add('show');
  document.getElementById('admin-pw-input').value = '';
  document.getElementById('login-error').style.display = 'none';
  setTimeout(() => document.getElementById('admin-pw-input').focus(), 100);
}

function checkAdminPw() {
  const pw = document.getElementById('admin-pw-input').value;
  if (pw === ADMIN_PASSWORD) {
    document.getElementById('admin-login-overlay').classList.remove('show');
    showAdminScreen();
  } else {
    document.getElementById('login-error').style.display = 'block';
  }
}

async function showAdminScreen() {
  showScreen('screen-admin');
  await refreshAdminPreviews();
  loadAdminPosts();
  loadArticleUrls();
}

// ‚îÄ‚îÄ‚îÄ RSS cache helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshRSS() {
  const btn = document.getElementById('refresh-btn');
  const statusEl = document.getElementById('rss-status');
  btn.disabled = true;
  btn.textContent = '‚Üª Refreshing‚Ä¶';
  statusEl.textContent = 'Fetching latest articles from RSS feeds‚Ä¶';
  try {
    await fetch('/api/rss/refresh', { method: 'POST' });
    // Poll for completion ‚Äî check every 2s for up to 30s
    let attempts = 0;
    const poll = setInterval(async () => {
      attempts++;
      const res = await fetch('/api/rss');
      const data = await res.json();
      if (data.fetchedAt) {
        clearInterval(poll);
        btn.disabled = false;
        btn.textContent = '‚Üª Refresh Articles';
        const count = data.items ? data.items.length : 0;
        const when = new Date(data.fetchedAt).toLocaleTimeString();
        statusEl.textContent = `‚úì ${count} articles cached at ${when}. Ready to generate.`;
        statusEl.style.color = 'var(--green)';
      }
      if (attempts > 15) {
        clearInterval(poll);
        btn.disabled = false;
        btn.textContent = '‚Üª Refresh Articles';
        statusEl.textContent = 'Refresh complete. Click Generate to create questions.';
      }
    }, 2000);
  } catch(e) {
    btn.disabled = false;
    btn.textContent = '‚Üª Refresh Articles';
    statusEl.textContent = 'Refresh failed: ' + e.message;
    statusEl.style.color = 'var(--red)';
  }
}

async function loadRSSStatus() {
  try {
    const res = await fetch('/api/rss');
    const data = await res.json();
    const statusEl = document.getElementById('rss-status');
    if (statusEl) {
      if (data.fetchedAt) {
        const count = data.items ? data.items.length : 0;
        const when = new Date(data.fetchedAt).toLocaleTimeString();
        statusEl.textContent = `‚úì ${count} articles cached at ${when}. Click Generate or Refresh Articles for latest.`;
        statusEl.style.color = 'var(--green)';
      } else {
        statusEl.textContent = 'No articles cached yet. Click ‚Üª Refresh Articles first.';
        statusEl.style.color = 'var(--muted)';
      }
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ Admin inbox & moderation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadAdminMessages() {
  const el = document.getElementById('admin-messages');
  if (!el) return;
  try {
    const res = await fetch('/api/messages');
    const data = await res.json();
    const msgs = data.messages || [];
    const unread = msgs.filter(m => !m.read).length;
    const badge = document.getElementById('unread-badge');
    if (badge) {
      badge.style.display = unread > 0 ? 'inline' : 'none';
      badge.textContent = unread + ' new';
    }
    if (msgs.length === 0) {
      el.innerHTML = '<p style="font-family:monospace;font-size:12px;color:var(--muted);">No messages yet.</p>';
      return;
    }
    el.innerHTML = msgs.map(m => `
      <div style="background:${m.read ? 'white' : 'var(--cream)'};border:1px solid var(--rule);padding:12px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <strong style="font-family:monospace;font-size:12px;">${escHtml(m.playerName)}</strong>
          <span style="font-family:monospace;font-size:10px;color:var(--muted);">${new Date(m.createdAt).toLocaleString()}${m.read ? '' : ' ¬∑ <strong>NEW</strong>'}</span>
        </div>
        <p style="font-size:13px;margin:0 0 8px;">${escHtml(m.text)}</p>
        ${!m.read ? `<button onclick="markRead('${m.id}')" style="font-family:monospace;font-size:11px;padding:4px 10px;cursor:pointer;">Mark read</button>` : ''}
      </div>`).join('');
  } catch(e) {
    el.innerHTML = '<p style="color:var(--red);font-size:12px;">Could not load messages.</p>';
  }
}

async function markRead(id) {
  await fetch(`/api/messages/${id}/read`, { method: 'POST' });
  loadAdminMessages();
}

async function loadAdminPosts() {
  const el = document.getElementById('admin-posts-list');
  if (!el) return;
  try {
    const res = await fetch('/api/posts');
    const data = await res.json();
    const posts = data.posts || [];
    if (posts.length === 0) {
      el.innerHTML = '<p style="font-family:monospace;font-size:12px;color:var(--muted);">No posts yet.</p>';
      return;
    }
    el.innerHTML = posts.map(p => `
      <div style="background:white;border:1px solid var(--rule);padding:12px;margin-bottom:8px;display:flex;gap:12px;align-items:flex-start;">
        <div style="flex:1;">
          <strong style="font-family:monospace;font-size:12px;">${escHtml(p.playerName)}</strong>
          <span style="font-family:monospace;font-size:10px;color:var(--muted);margin-left:8px;">${new Date(p.createdAt).toLocaleString()}</span>
          <p style="font-size:13px;margin:4px 0 0;">${escHtml(p.text)}</p>
        </div>
        <button onclick="deletePost('${p.id}')" style="font-family:monospace;font-size:11px;padding:4px 10px;background:var(--red);color:white;border:none;cursor:pointer;white-space:nowrap;">Delete</button>
      </div>`).join('');
  } catch(e) {
    el.innerHTML = '<p style="color:var(--red);font-size:12px;">Could not load posts.</p>';
  }
}

async function deletePost(id) {
  if (!confirm('Delete this post?')) return;
  await fetch(`/api/posts/${id}`, { method: 'DELETE' });
  loadAdminPosts();
}

// ‚îÄ‚îÄ‚îÄ Admin inbox & moderation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadAdminMessages() {
  const el = document.getElementById('admin-messages');
  if (!el) return;
  try {
    const res = await fetch('/api/messages');
    const data = await res.json();
    const msgs = data.messages || [];
    const unread = msgs.filter(m => !m.read).length;
    const badge = document.getElementById('unread-badge');
    if (badge) { badge.style.display = unread > 0 ? 'inline' : 'none'; badge.textContent = unread + ' new'; }
    if (msgs.length === 0) { el.innerHTML = '<p style="font-family:courier,monospace;font-size:12px;color:var(--muted);">No messages yet.</p>'; return; }
    el.innerHTML = msgs.map(m => `
      <div style="background:${m.read ? 'white' : 'var(--cream)'};border:1px solid var(--rule);padding:12px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <strong style="font-family:monospace;font-size:12px;">${escHtml(m.playerName)}</strong>
          <span style="font-family:monospace;font-size:10px;color:var(--muted);">${new Date(m.createdAt).toLocaleString()}${m.read ? '' : ' ¬∑ NEW'}</span>
        </div>
        <p style="font-size:13px;margin:0 0 8px;">${escHtml(m.text)}</p>
        ${!m.read ? `<button onclick="markRead('${m.id}')" style="font-family:monospace;font-size:11px;padding:4px 10px;cursor:pointer;">Mark read</button>` : ''}
      </div>`).join('');
  } catch(e) { el.innerHTML = '<p style="color:var(--red);font-size:12px;">Could not load messages.</p>'; }
}

async function markRead(id) {
  await fetch('/api/messages/' + id + '/read', { method: 'POST' });
  loadAdminMessages();
}

async function loadAdminPosts() {
  const el = document.getElementById('admin-posts-list');
  if (!el) return;
  try {
    const res = await fetch('/api/posts');
    const data = await res.json();
    const posts = data.posts || [];
    if (posts.length === 0) { el.innerHTML = '<p style="font-family:courier,monospace;font-size:12px;color:var(--muted);">No posts yet.</p>'; return; }
    el.innerHTML = posts.map(p => `
      <div style="background:white;border:1px solid var(--rule);padding:12px;margin-bottom:8px;display:flex;gap:12px;align-items:flex-start;">
        <div style="flex:1;">
          <strong style="font-family:monospace;font-size:12px;">${escHtml(p.playerName)}</strong>
          <span style="font-family:monospace;font-size:10px;color:var(--muted);margin-left:8px;">${new Date(p.createdAt).toLocaleString()}</span>
          <p style="font-size:13px;margin:4px 0 0;">${escHtml(p.text)}</p>
        </div>
        <button onclick="deletePost('${p.id}')" style="font-family:monospace;font-size:11px;padding:4px 10px;background:var(--red);color:white;border:none;cursor:pointer;white-space:nowrap;">Delete</button>
      </div>`).join('');
  } catch(e) { el.innerHTML = '<p style="color:var(--red);font-size:12px;">Could not load posts.</p>'; }
}

async function deletePost(id) {
  if (!confirm('Delete this post?')) return;
  await fetch('/api/posts/' + id, { method: 'DELETE' });
  loadAdminPosts();
}


// ‚îÄ‚îÄ‚îÄ Community board ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function getWeeklyCommentCount() {
  try {
    const res = await fetch('/api/posts');
    const data = await res.json();
    const posts = data.posts || [];
    const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
    return posts.filter(p => new Date(p.createdAt).getTime() > weekAgo).length;
  } catch(e) { return 0; }
}

function showCommunity() {
  showScreen('screen-community');
  loadPosts();
  // Pre-fill player name from leaderboard localStorage
  const name = lsGet('dnq_player_name') || '';
  if (name) {
    document.getElementById('board-name').value = name;
    document.getElementById('contact-name').value = name;
  }
}

function showContactForm() {
  showScreen('screen-contact');
  const name = lsGet('dnq_player_name') || '';
  if (name) document.getElementById('contact-name').value = name;
}

// Character counter for message board
document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('board-text');
  if (ta) {
    ta.addEventListener('input', () => {
      document.getElementById('board-char-count').textContent = `${ta.value.length} / 500`;
    });
  }
});

async function loadPosts() {
  const list = document.getElementById('posts-list');
  if (!list) return;
  list.innerHTML = '<p style="font-family:monospace;font-size:12px;color:var(--muted);">Loading posts‚Ä¶</p>';
  try {
    const res = await fetch('/api/posts');
    const data = await res.json();
    if (!data.posts || data.posts.length === 0) {
      list.innerHTML = '<p style="font-family:monospace;font-size:13px;color:var(--muted);text-align:center;padding:20px;">No posts yet ‚Äî be the first!</p>';
      return;
    }
    list.innerHTML = data.posts.map(p => `
      <div style="background:white;border:1px solid var(--rule);padding:14px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;">
          <strong style="font-family:monospace;font-size:13px;">${escHtml(p.playerName)}</strong>
          <span style="font-family:monospace;font-size:10px;color:var(--muted);">${new Date(p.createdAt).toLocaleString()}</span>
        </div>
        <p style="font-size:14px;line-height:1.5;margin:0;">${escHtml(p.text)}</p>
      </div>`).join('');
  } catch(e) {
    list.innerHTML = '<p style="color:var(--red);font-family:monospace;font-size:12px;">Could not load posts.</p>';
  }
}

async function submitPost() {
  const name = document.getElementById('board-name').value.trim();
  const text = document.getElementById('board-text').value.trim();
  const status = document.getElementById('board-status');

  if (!name) { showBoardStatus('Please enter your player name.', 'error'); return; }
  if (!text)  { showBoardStatus('Please write something before posting.', 'error'); return; }

  try {
    const res = await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playerName: name, text })
    });
    const data = await res.json();
    if (!res.ok) { showBoardStatus(data.error || 'Post failed.', 'error'); return; }
    document.getElementById('board-text').value = '';
    document.getElementById('board-char-count').textContent = '0 / 500';
    showBoardStatus('‚úì Posted!', 'success');
    lsSet('dnq_player_name', name);
    loadPosts();
  } catch(e) {
    showBoardStatus('Post failed. Try again.', 'error');
  }
}

function showBoardStatus(msg, type) {
  const el = document.getElementById('board-status');
  el.style.display = 'block';
  el.style.color = type === 'error' ? 'var(--red)' : 'var(--green)';
  el.textContent = msg;
  setTimeout(() => el.style.display = 'none', 3000);
}

async function submitContact() {
  const name = document.getElementById('contact-name').value.trim();
  const text = document.getElementById('contact-text').value.trim();

  if (!name) { showContactStatus('Please enter your player name.', 'error'); return; }
  if (!text)  { showContactStatus('Please write a message.', 'error'); return; }

  try {
    const res = await fetch('/api/contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playerName: name, text })
    });
    const data = await res.json();
    if (!res.ok) { showContactStatus(data.error || 'Send failed.', 'error'); return; }
    document.getElementById('contact-text').value = '';
    showContactStatus('‚úì Message sent to the editor!', 'success');
    lsSet('dnq_player_name', name);
  } catch(e) {
    showContactStatus('Send failed. Try again.', 'error');
  }
}

function showContactStatus(msg, type) {
  const el = document.getElementById('contact-status');
  el.style.display = 'block';
  el.style.color = type === 'error' ? 'var(--red)' : 'var(--green)';
  el.textContent = msg;
}

// ‚îÄ‚îÄ‚îÄ Community board ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showCommunity() {
  showScreen('screen-community');
  loadPosts();
  const name = lsGet('dnq_player_name') || '';
  if (name) {
    const bn = document.getElementById('board-name');
    const cn = document.getElementById('contact-name');
    if (bn) bn.value = name;
    if (cn) cn.value = name;
  }
}

function showContactForm() {
  showScreen('screen-contact');
  const name = lsGet('dnq_player_name') || '';
  const cn = document.getElementById('contact-name');
  if (cn && name) cn.value = name;
}

async function loadPosts() {
  const list = document.getElementById('posts-list');
  if (!list) return;
  list.innerHTML = '<p style="font-family:monospace;font-size:12px;color:var(--muted);">Loading‚Ä¶</p>';
  try {
    const res = await fetch('/api/posts');
    const data = await res.json();
    if (!data.posts || data.posts.length === 0) {
      list.innerHTML = '<p style="font-family:monospace;font-size:13px;color:var(--muted);text-align:center;padding:20px;">No posts yet ‚Äî be the first!</p>';
      return;
    }
    list.innerHTML = data.posts.map(p => `
      <div style="background:white;border:1px solid var(--rule);padding:14px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;">
          <strong style="font-family:monospace;font-size:13px;">${escHtml(p.playerName)}</strong>
          <span style="font-family:monospace;font-size:10px;color:var(--muted);">${new Date(p.createdAt).toLocaleString()}</span>
        </div>
        <p style="font-size:14px;line-height:1.5;margin:0;">${escHtml(p.text)}</p>
      </div>`).join('');
  } catch(e) {
    list.innerHTML = '<p style="color:var(--red);font-family:monospace;font-size:12px;">Could not load posts.</p>';
  }
}

async function submitPost() {
  const name = document.getElementById('board-name').value.trim();
  const text = document.getElementById('board-text').value.trim();
  if (!name) { showBoardStatus('Please enter your player name.', 'error'); return; }
  if (!text)  { showBoardStatus('Please write something.', 'error'); return; }
  try {
    const res = await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playerName: name, text })
    });
    const data = await res.json();
    if (!res.ok) { showBoardStatus(data.error || 'Post failed.', 'error'); return; }
    document.getElementById('board-text').value = '';
    document.getElementById('board-char-count').textContent = '0 / 500';
    showBoardStatus('‚úì Posted!', 'success');
    lsSet('dnq_player_name', name);
    loadPosts();
  } catch(e) { showBoardStatus('Post failed. Try again.', 'error'); }
}

function showBoardStatus(msg, type) {
  const el = document.getElementById('board-status');
  el.style.display = 'block';
  el.style.color = type === 'error' ? 'var(--red)' : 'var(--green)';
  el.textContent = msg;
  setTimeout(() => el.style.display = 'none', 3000);
}

async function submitContact() {
  const name = document.getElementById('contact-name').value.trim();
  const text = document.getElementById('contact-text').value.trim();
  if (!name) { showContactStatus('Please enter your player name.', 'error'); return; }
  if (!text)  { showContactStatus('Please write a message.', 'error'); return; }
  try {
    const res = await fetch('/api/contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playerName: name, text })
    });
    const data = await res.json();
    if (!res.ok) { showContactStatus(data.error || 'Send failed.', 'error'); return; }
    document.getElementById('contact-text').value = '';
    showContactStatus('‚úì Message sent to the editor!', 'success');
    lsSet('dnq_player_name', name);
  } catch(e) { showContactStatus('Send failed. Try again.', 'error'); }
}

function showContactStatus(msg, type) {
  const el = document.getElementById('contact-status');
  el.style.display = 'block';
  el.style.color = type === 'error' ? 'var(--red)' : 'var(--green)';
  el.textContent = msg;
}

// ‚îÄ‚îÄ‚îÄ Community board ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showCommunity() {
  showScreen('screen-community');
  loadPosts();
  const name = lsGet('dnq_player_name') || '';
  const bn = document.getElementById('board-name');
  const cn = document.getElementById('contact-name');
  if (bn && name) bn.value = name;
  if (cn && name) cn.value = name;
}

function showContactForm() {
  showScreen('screen-contact');
  const name = lsGet('dnq_player_name') || '';
  const cn = document.getElementById('contact-name');
  if (cn && name) cn.value = name;
}

async function loadPosts() {
  const list = document.getElementById('posts-list');
  if (!list) return;
  list.innerHTML = '<p style="font-family:courier,monospace;font-size:12px;color:var(--muted);">Loading‚Ä¶</p>';
  try {
    const res = await fetch('/api/posts');
    const data = await res.json();
    if (!data.posts || data.posts.length === 0) {
      list.innerHTML = '<p style="font-family:courier,monospace;font-size:13px;color:var(--muted);text-align:center;padding:20px;">No posts yet ‚Äî be the first!</p>';
      return;
    }
    list.innerHTML = data.posts.map(p => `
      <div style="background:white;border:1px solid var(--rule);padding:14px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;">
          <strong style="font-family:\'Courier Prime\',monospace;font-size:13px;">${escHtml(p.playerName)}</strong>
          <span style="font-family:\'Courier Prime\',monospace;font-size:10px;color:var(--muted);">${new Date(p.createdAt).toLocaleString()}</span>
        </div>
        <p style="font-size:14px;line-height:1.5;margin:0;">${escHtml(p.text)}</p>
      </div>`).join('');
  } catch(e) {
    list.innerHTML = '<p style="color:var(--red);">Could not load posts.</p>';
  }
}

async function submitPost() {
  const name = document.getElementById('board-name').value.trim();
  const text = document.getElementById('board-text').value.trim();
  if (!name) { showBoardStatus('Please enter your player name.', 'error'); return; }
  if (!text)  { showBoardStatus('Please write something.', 'error'); return; }
  try {
    const res = await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playerName: name, text })
    });
    const data = await res.json();
    if (!res.ok) { showBoardStatus(data.error || 'Post failed.', 'error'); return; }
    document.getElementById('board-text').value = '';
    document.getElementById('board-char-count').textContent = '0 / 500';
    showBoardStatus('‚úì Posted!', 'success');
    lsSet('dnq_player_name', name);
    loadPosts();
  } catch(e) { showBoardStatus('Post failed. Try again.', 'error'); }
}

function showBoardStatus(msg, type) {
  const el = document.getElementById('board-status');
  el.style.display = 'block';
  el.style.color = type === 'error' ? 'var(--red)' : 'var(--green)';
  el.textContent = msg;
  setTimeout(() => el.style.display = 'none', 3000);
}

async function submitContact() {
  const name = document.getElementById('contact-name').value.trim();
  const text = document.getElementById('contact-text').value.trim();
  if (!name) { showContactStatus('Please enter your player name.', 'error'); return; }
  if (!text)  { showContactStatus('Please write a message.', 'error'); return; }
  try {
    const res = await fetch('/api/contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playerName: name, text })
    });
    const data = await res.json();
    if (!res.ok) { showContactStatus(data.error || 'Send failed.', 'error'); return; }
    document.getElementById('contact-text').value = '';
    showContactStatus('‚úì Message sent to the editor!', 'success');
    lsSet('dnq_player_name', name);
  } catch(e) { showContactStatus('Send failed. Try again.', 'error'); }
}

function showContactStatus(msg, type) {
  const el = document.getElementById('contact-status');
  el.style.display = 'block';
  el.style.color = type === 'error' ? 'var(--red)' : 'var(--green)';
  el.textContent = msg;
}


// ‚îÄ‚îÄ‚îÄ Saved news sites (server-side) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveArticleUrls() {
  const val = document.getElementById('article-urls-input').value.trim();
  lsSet('dnq_article_urls', val);
  const msg = document.getElementById('article-urls-saved-msg');
  msg.style.display = 'inline';
  setTimeout(() => { msg.style.display = 'none'; }, 2000);
}

function clearArticleUrls() {
  if (!confirm('Clear all saved article URLs?')) return;
  lsSet('dnq_article_urls', '');
  document.getElementById('article-urls-input').value = '';
}

function loadArticleUrls() {
  const saved = lsGet('dnq_article_urls') || '';
  if (saved) document.getElementById('article-urls-input').value = saved;
}

async function saveSites() {
  const val = document.getElementById('urls-input').value.trim();
  const msg = document.getElementById('sites-saved-msg');
  msg.style.display = 'inline';
  msg.style.color = 'var(--muted)';
  msg.textContent = 'Saving‚Ä¶';
  try {
    const res = await fetch('/api/sites', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sites: val })
    });
    if (res.ok) {
      msg.textContent = '‚úì Sites saved!';
      msg.style.color = 'var(--green)';
    } else {
      msg.textContent = '‚úó Save failed';
      msg.style.color = 'var(--red)';
    }
  } catch(e) {
    msg.textContent = '‚úó Save failed';
    msg.style.color = 'var(--red)';
  }
  setTimeout(() => { msg.style.display = 'none'; }, 3000);
}

async function loadSavedSites() {
  try {
    const res = await fetch('/api/sites');
    if (res.ok) {
      const data = await res.json();
      if (data.sites) {
        document.getElementById('urls-input').value = data.sites;
      }
    }
  } catch(e) {
    // Server not available ‚Äî silently fall back to empty
  }
}

async function refreshAdminPreviews() {
  // Load saved news sites from server
  await loadSavedSites();
  loadRSSStatus();
  loadAdminMessages();
  loadAdminPosts();

  // Archive count
  const archive = getArchive();
  document.getElementById('archive-count').textContent = archive.length;

  // Archive preview (first 20)
  const prev = archive.slice(0,20);
  document.getElementById('archive-preview').innerHTML = prev.map(q =>
    `<span class="archive-pill">${escHtml(q.slice(0,50))}‚Ä¶</span>`
  ).join('') + (archive.length > 20 ? `<span class="archive-pill">+${archive.length-20} more</span>` : '');

  // Today's published
  const today = getTodayQuiz();
  if (today && today.questions) {
    document.getElementById('published-preview').innerHTML =
      `<p style="color:var(--green);font-family:monospace;font-size:12px;margin-bottom:8px;">‚úì ${today.questions.length} questions published for ${todayStr()}</p>` +
      today.questions.slice(0,3).map((q,i) => `<div class="q-review-card"><div class="q-meta"><span>Q${i+1}</span></div><div class="q-preview">${escHtml(q.question.slice(0,100))}‚Ä¶</div></div>`).join('');
  } else {
    document.getElementById('published-preview').innerHTML = `<p style="font-size:13px;color:var(--muted);font-style:italic;">No quiz published today.</p>`;
  }

  // Draft
  const draft = getDraftQuiz();
  if (draft && draft.questions) {
    showDraftPreview(draft.questions);
  }
}

function setStatus(msg, type) {
  const el = document.getElementById('gen-status');
  el.textContent = msg;
  el.className = 'status-msg show ' + type;
}

async function generateQuestions() {
  const urls = document.getElementById('urls-input').value.trim();
  const articleUrls = document.getElementById('article-urls-input').value.trim();
  const manualText = document.getElementById('manual-text-input').value.trim();

  if (!urls && !articleUrls && !manualText) {
    setStatus('Please paste at least one news site URL ‚Äî or paste article text directly.', 'error');
    return;
  }

  document.getElementById('gen-btn').disabled = true;
  document.getElementById('gen-overlay').classList.add('show');
  document.getElementById('preview-section').style.display = 'none';
  document.getElementById('raw-debug').style.display = 'none';
  setStatus('', '');

  // Article URLs = hand-picked specific articles (one-time, not saved)
  // Feed URLs = RSS/site URLs saved in the feeds box
  const articleUrlList = articleUrls ? articleUrls.split('\n').map(u => u.trim()).filter(u => u.startsWith('http')) : [];
  const urlList = urls ? urls.split('\n').map(u => u.trim()).filter(u => u.startsWith('http')) : [];
  const archive = getArchive();
  const archiveNote = archive.length > 0
    ? `Do NOT generate questions about these previously used topics: ${archive.slice(0, 30).join(' | ')}`
    : '';

  // Always fetch RSS cache. If specific articles are provided, they go first;
  // RSS articles are used only to fill remaining slots up to 11.
  const isFeedMode = articleUrlList.length === 0;

  let rssContent = '';
  try {
    const rssRes = await fetch('/api/rss');
    if (rssRes.ok) {
      const rssData = await rssRes.json();
      if (rssData.items && rssData.items.length > 0) {
          // Interleave articles across sources so Claude sees variety from the start
          const bySource = {};
          for (const item of rssData.items) {
            const domain = item.source || 'unknown';
            if (!bySource[domain]) bySource[domain] = [];
            if (bySource[domain].length < 4) bySource[domain].push(item);
          }
          const sourceQueues = Object.values(bySource);
          const interleaved = [];
          let added = true;
          while (added) {
            added = false;
            for (const queue of sourceQueues) {
              if (queue.length > 0) { interleaved.push(queue.shift()); added = true; }
            }
          }
          rssContent = interleaved.map((item, idx) =>
            `ARTICLE ${idx + 1}:\nSOURCE: ${item.source}\nHEADLINE: ${item.title}\nSUMMARY: ${item.description}\nURL: ${item.link}\nDATE: ${item.pubDate}`
          ).join('\n\n---\n\n');
        }
      }
    } catch(e) { /* cache unavailable, proceed without */ }

  // ‚îÄ‚îÄ Step 1: Pre-screen RSS articles for newsworthiness ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Only run pre-screening when using RSS feed (not hand-picked articles)
  if (isFeedMode && rssContent) {
    document.getElementById('gen-progress-text').textContent = 'Evaluating articles‚Ä¶';
    try {
      const blocks = rssContent.split('---').map(b => b.trim()).filter(Boolean);
      const headlines = blocks.map((b, i) => {
        const m = b.match(/HEADLINE: (.+)/);
        const u = b.match(/URL: (.+)/);
        return `${i}: ${m ? m[1].trim() : '(no headline)'} | ${u ? u[1].trim() : ''}`;
      }).join('\n');

      const screenPrompt = 'You are an editor screening articles for a Baltimore local news quiz. ' +
        'For each article below, decide if it is suitable for a quiz question.\n\n' +
        'REJECT if any of these apply:\n' +
        '- Profile or anniversary piece with no specific news event (e.g. school founded X years ago, person profile)\n' +
        '- Weather forecast or routine temperature update\n' +
        '- DC team sports story (Nationals, Commanders, Capitals, Wizards) with no Baltimore/Maryland angle\n' +
        '- Routine sports transaction, injury update, or spring training note\n' +
        '- Any story where the only interesting question would involve a number, date, or dollar amount\n' +
        '- Headline roundups or "morning headlines" digest articles\n\n' +
        'ACCEPT if:\n' +
        '- A specific newsworthy event happened (decision, vote, lawsuit, opening, closing, arrest of public figure)\n' +
        '- Involves public money, elections, housing, schools, health, or local economy\n' +
        '- A well-informed Baltimorean would mention it to a friend over coffee\n\n' +
        'ARTICLES:\n' + headlines + '\n\n' +
        'Respond with ONLY a JSON array of the indices you ACCEPT. Example: [0,2,4,7,9]. No explanation.';

      const screenController = new AbortController();
      const screenTimer = setTimeout(() => screenController.abort(), 30000);
      let screenResponse;
      try {
        screenResponse = await fetch('/api/claude', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          signal: screenController.signal,
          body: JSON.stringify({
            model: CLAUDE_MODEL,
            max_tokens: 200,
            messages: [{ role: 'user', content: screenPrompt }]
          })
        });
      } finally {
        clearTimeout(screenTimer);
      }

      const screenData = await screenResponse.json();
      if (!screenData.error && screenData.content && screenData.content.length) {
        const screenText = screenData.content.map(c => c.text || '').join('').trim();
        const clean = screenText.replace(/```json|```/g, '').trim();
        const acceptedIndices = JSON.parse(clean);
        console.log(`[PreScreen] Accepted ${acceptedIndices.length} of ${blocks.length} articles:`, acceptedIndices);
        // Rebuild rssContent with only accepted blocks
        const acceptedBlocks = acceptedIndices
          .filter(i => i >= 0 && i < blocks.length)
          .map(i => blocks[i]);
        rssContent = acceptedBlocks.join('\n\n---\n\n');
        console.log(`[PreScreen] RSS content filtered to ${acceptedBlocks.length} articles`);
      }
    } catch(e) {
      console.warn('[PreScreen] Screening step failed, proceeding with full RSS:', e.message);
    }
  }

  // ‚îÄ‚îÄ Step 1.5: Fetch full article text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // For each article in the screened RSS pool, attempt to fetch full text.
  // Fall back to RSS excerpt if fetch fails or returns too little (paywall).
  if (rssContent) {
    document.getElementById('gen-progress-text').textContent = 'Fetching article content‚Ä¶';
    const blocks = rssContent.split('---').map(b => b.trim()).filter(Boolean);
    const enriched = await Promise.all(blocks.map(async (block) => {
      const urlMatch = block.match(/URL: (.+)/);
      if (!urlMatch) return block;
      const articleUrl = urlMatch[1].trim();
      try {
        const fetchRes = await fetch('/api/fetch-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: articleUrl })
        });
        const fetchData = await fetchRes.json();
        if (fetchData.ok && fetchData.excerpt && fetchData.excerpt.length > 200) {
          console.log(`[ArticleFetch] Full text retrieved: ${articleUrl.slice(0,60)}`);
          // Replace or append SUMMARY with full text
          if (block.includes('SUMMARY:')) {
            return block.replace(/SUMMARY:[\s\S]*$/, 'FULL TEXT:\n' + fetchData.excerpt);
          }
          return block + '\nFULL TEXT:\n' + fetchData.excerpt;
        } else {
          console.log(`[ArticleFetch] Paywall/failed (${fetchData.reason}): ${articleUrl.slice(0,60)}`);
          return block; // keep RSS excerpt
        }
      } catch(e) {
        return block; // keep RSS excerpt on error
      }
    }));
    rssContent = enriched.join('\n\n---\n\n');
  }

  const prompt = buildGenerationPrompt(urlList, articleUrlList, manualText, archiveNote, rssContent, isFeedMode);
  let rawResponse = '';

  // ‚îÄ‚îÄ Step 2: Generate questions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('gen-progress-text').textContent = 'Generating questions‚Ä¶';

  try {
    const claudeController = new AbortController();
    const claudeTimer = setTimeout(() => claudeController.abort(), 60000);
    let response;
    try {
      response = await fetch('/api/claude', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        signal: claudeController.signal,
        body: JSON.stringify({
          model: CLAUDE_MODEL,
          max_tokens: 4000,
          messages: [{ role: 'user', content: prompt }]
        })
      });
    } finally {
      clearTimeout(claudeTimer);
    }

    const data = await response.json();
    if (data.error) throw new Error(`API error: ${data.error.message}`);
    if (!data.content || !data.content.length) throw new Error('API returned empty content. Check your API key.');

    rawResponse = data.content.map(b => b.text || '').join('');
    showRawDebug(rawResponse);

    const questions = parseQuestions(rawResponse);

    if (questions.length === 0) {
      throw new Error('Claude returned a response but no questions were parsed. See Raw Response below.');
    }

    if (questions.length < 6) {
      setStatus(`‚ö† Only ${questions.length} questions generated ‚Äî you need 6 to publish. Add more article URLs and regenerate.`, 'error');
    } else if (!document.getElementById('gen-status').classList.contains('error')) {
      setStatus(`‚úì ${questions.length} questions generated. Review below, then publish.`, 'success');
    }

    if (questions.length > 0) {
      saveDraftQuiz({ questions, generatedAt: new Date().toISOString(), urls: urlList });
      showDraftPreview(questions);
    }

  } catch (err) {
    setStatus('Error: ' + err.message, 'error');
    if (rawResponse) showRawDebug(rawResponse);
    console.error(err);
  } finally {
    document.getElementById('gen-btn').disabled = false;
    document.getElementById('gen-overlay').classList.remove('show');
  }
}

function showRawDebug(text) {
  const el = document.getElementById('raw-debug');
  el.style.display = 'block';
  document.getElementById('raw-debug-text').textContent = text;
}

function buildGenerationPrompt(urlList, articleUrlList, manualText, archiveNote, rssContent, isFeedMode) {
  const manualBlock = manualText
    ? 'MANUALLY PROVIDED ARTICLE TEXT (use as additional source):\n' + manualText.slice(0, 4000)
    : '';

  const isSpecificArticles = articleUrlList.length > 0;

  const fallback = !rssContent && !manualBlock && !isSpecificArticles
    ? 'Search for and read the most recent articles from these Baltimore news websites:\n' + urlList.join('\n')
    : '';

  const specificArticlesBlock = isSpecificArticles
    ? 'SPECIFIC ARTICLES TO USE (fetch and use ONLY these exact URLs ‚Äî do not browse to other stories, do not use RSS cache, do not add articles from training knowledge):\n' + articleUrlList.join('\n')
    : '';

  // ‚îÄ‚îÄ Topic deduplication: pick 11 topically distinct articles ‚îÄ‚îÄ
  function topicWords(headline) {
    const stop = new Set(['a','an','the','and','or','but','in','on','at','to','for','of','with',
      'is','are','was','were','be','been','has','have','had','will','would','that','this','as',
      'from','by','after','over','about','how','what','who','when','where','says','say','amid',
      'new','more','year','week','day','monday','tuesday','wednesday','thursday','friday',
      'saturday','sunday','after','its','their','amid','into','than','some','could','local']);
    return headline.toLowerCase().replace(/[^a-z0-9 ]/g, ' ').split(/\s+/)
      .filter(w => w.length > 3 && !stop.has(w));
  }

  function topicsOverlap(h1, h2) {
    const w1 = new Set(topicWords(h1));
    return topicWords(h2).filter(w => w1.has(w)).length >= 3;
  }

  const difficulties = ['easy','easy','medium','medium','hard','bonus'];
  const points =       ['10',  '10',  '20',  '20',  '30',  '50'];

  let assignedArticles = '';

  if (isSpecificArticles) {
    // Specific articles go first, guaranteed. RSS fills remaining slots up to 11.
    const specificBlocks = articleUrlList.map((url, i) =>
      `ARTICLE ${i + 1}:\nURL: ${url}`
    );
    const chosenHeadlines = []; // track headlines from RSS fill to dedup
    const rssBlocks = [];

    if (rssContent) {
      const blocks = rssContent.split('---').map(b => b.trim()).filter(Boolean);
      const needed = 6 - specificBlocks.length;
      console.log(`[TopicDedup] ${specificBlocks.length} specific articles, need ${needed} more from RSS`);
      for (const block of blocks) {
        if (rssBlocks.length >= needed) break;
        const m = block.match(/HEADLINE: (.+)/);
        if (!m) continue;
        const headline = m[1].trim();
        const overlap = chosenHeadlines.find(h => topicsOverlap(h, headline));
        if (overlap) {
          console.log(`[TopicDedup] SKIPPED (overlaps with "${overlap}"): ${headline}`);
          continue;
        }
        chosenHeadlines.push(headline);
        rssBlocks.push(block);
        console.log(`[TopicDedup] RSS FILL (${rssBlocks.length}/${needed}): ${headline}`);
      }
    }

    const allBlocks = [...specificBlocks, ...rssBlocks];
    assignedArticles = allBlocks.map((block, i) => {
      const label = i < specificBlocks.length ? ' [EDITOR PICK]' : '';
      return 'QUESTION ' + (i+1) + ' (' + difficulties[i] + ', ' + points[i] + ' pts)' + label + ' ‚Äî write exactly ONE question about THIS article:\n' + block;
    }).join('\n\n===\n\n');

  } else if (rssContent) {
    const blocks = rssContent.split('---').map(b => b.trim()).filter(Boolean);
    const chosen = [];
    const chosenHeadlines = [];
    console.log(`[TopicDedup] Starting with ${blocks.length} article blocks`);
    for (const block of blocks) {
      const m = block.match(/HEADLINE: (.+)/);
      if (!m) continue;
      const headline = m[1].trim();
      const overlap = chosenHeadlines.find(h => topicsOverlap(h, headline));
      if (overlap) {
        console.log(`[TopicDedup] SKIPPED (overlaps with "${overlap}"): ${headline}`);
        continue;
      }
      chosenHeadlines.push(headline);
      chosen.push(block);
      console.log(`[TopicDedup] CHOSEN (${chosen.length}/11): ${headline}`);
      if (chosen.length >= 6) break;
    }
    console.log(`[TopicDedup] Final count: ${chosen.length} articles assigned to Claude`);
    assignedArticles = chosen.map((block, i) =>
      'QUESTION ' + (i+1) + ' (' + difficulties[i] + ', ' + points[i] + ' pts) ‚Äî write exactly ONE question about THIS article:\n' + block
    ).join('\n\n===\n\n');
  }

  return 'You are writing questions for a LOCAL NEWS QUIZ about Baltimore and the Central Maryland region.\n\n' +
    (specificArticlesBlock ? specificArticlesBlock + '\n\n' : '') +
    (manualBlock ? manualBlock + '\n\n' : '') +
    (fallback ? fallback + '\n\n' : '') +
    (archiveNote ? 'PREVIOUSLY USED TOPICS ‚Äî do not repeat these:\n' + archiveNote + '\n\n' : '') +
    'INSTRUCTIONS:\n' +
    '- Write exactly one question per numbered article ‚Äî use ONLY the assigned article for that question\n' +
    '- Each article is used for exactly one question ‚Äî do not reuse any article\n' +
    '- If two articles cover the same event or person, only the first one appears below ‚Äî ignore any duplicates\n' +
    '- Use the exact URL from each article as the sourceUrl\n' +
    '- Do NOT use training knowledge ‚Äî only facts from the assigned article\n' +
    '- Keep all questions appropriate for a general community audience\n' +
    '- For articles touching national topics, frame the question around the Maryland/Baltimore local angle\n\n' +
    'QUESTION FOCUS RULES (critical ‚Äî read carefully):\n' +
    '- Ask about the WHO or WHAT that makes the story newsworthy, NOT the how much, how long, or how many\n' +
    '- Good question subjects: names of companies, people, organizations, places, decisions, and actions\n' +
    '- Bad question subjects: dollar amounts, durations, unit counts, vote tallies, dates, and times ‚Äî unless the number itself IS the headline (e.g. a record-breaking figure everyone is talking about)\n' +
    '- Example: a story about Primanti Bros. closing ‚Üí ask which chain closed, NOT how long it operated\n' +
    '- Example: a story about a new airline route ‚Üí ask which airline, NOT which destination\n' +
    '- Example: a real estate acquisition ‚Üí ask which developer, NOT how many units\n' +
    '- The correct answer should be something a well-informed Baltimorean might actually know or want to know\n' +
    '- Skip crime stories unless a recognizable institution, public figure, or place is central to the story\n\n' +
    'ARTICLE SELECTION FILTER ‚Äî before writing a question, ask: would a typical Baltimore news reader who does not closely follow this topic find this story interesting or important? If no, skip it and use the next available article instead.\n' +
    '- SKIP: routine sports transaction or injury updates (a pitcher refining mechanics, a trade rumor, a player signing a minor deal)\n' +
    '- SKIP: minor arts/culture items with no broader community impact (a small gallery opening, a local band releasing an album)\n' +
    '- SKIP: individual crime stories unless a recognizable public figure, major institution, or significant pattern is central\n' +
    '- SKIP: ALL weather stories ‚Äî forecasts, First Alert days, temperature records ‚Äî unless a historic storm caused major documented damage\n' +
    '- SKIP: anniversary or milestone articles (school founded X years ago, business celebrating Y anniversary) unless a specific newsworthy development is the focus (a closure, a major donation, a scandal)\n' +
    '- SKIP: stories about DC-area teams (Nationals, Commanders, Capitals, Wizards) unless there is an explicit and specific Baltimore or Maryland angle ‚Äî spring training updates and player health stories about DC teams do not qualify\n' +
    '- SKIP: any story where the only interesting question would involve a specific number, date, dollar amount, or duration\n' +
    '- USE: sports stories about record-breaking achievements, major roster decisions, or stadium/ownership news\n' +
    '- USE: arts/culture stories involving major institutions (BSO, BMA, Center Stage) or nationally recognized figures\n' +
    '- USE: anything involving public money, public safety, elections, housing, schools, or the local economy\n' +
    '- USE: anything a well-informed Baltimorean might mention to a friend over coffee that morning\n\n' +
    '- Wrong answers must be the same category as the correct answer\n' +
    '  ¬∑ If the answer is an airline ‚Üí other real airlines (preferably ones serving the Mid-Atlantic)\n' +
    '  ¬∑ If the answer is a restaurant chain ‚Üí other real restaurant chains a Baltimorean would recognize\n' +
    '  ¬∑ If the answer is a developer or company ‚Üí other real companies in that industry\n' +
    '  ¬∑ If the answer is a politician or official ‚Üí other real politicians at a similar level\n' +
    '  ¬∑ If the answer is a neighborhood or place ‚Üí other real Baltimore-area places\n' +
    '- Wrong answers should be plausible enough that someone who did NOT read the article might pick them\n' +
    '- Wrong answers should NOT be so similar to the correct answer that they are confusing\n' +
    '- Wrong answers should NOT be obviously absurd or unrelated (e.g. do not list "NASA" as a wrong answer for a question about a restaurant)\n' +
    '- Never use four options that are all dates, all dollar amounts, or all nearly identical numbers\n\n' +
    '- easy (Q1-Q2, 10pts): Answerable from the headline. The correct answer is the main subject of the story. Wrong answers should be clearly different but plausible.\n' +
    '- medium (Q3, 20pts): Requires reading ‚Äî test knowledge of key facts, decisions, or outcomes. Wrong answers should be plausible but clearly distinct.\n' +
    '- hard (Q4-Q5, 30pts): Tests a specific supporting detail that a close reader would remember ‚Äî a name, a place, a stated reason, or a key outcome. Do NOT ask about dollar amounts, dates, durations, or unit counts unless the number is the entire point of the story.\n' +
    '- bonus (Q11, 50pts): The single most memorable specific detail in the article ‚Äî ideally a surprising or counterintuitive fact. Wrong answers should be nearby but clearly distinct.\n\n' +
    'HERE ARE YOUR 6 ASSIGNED ARTICLES:\n\n' +
    (assignedArticles || rssContent) + '\n\n' +
    'OUTPUT: Respond with ONLY valid JSON. No preamble, no markdown. Start with { and end with }.\n\n' +
    '{\n  "staleWarning": false,\n  "staleArticles": [],\n  "questions": [\n' +
    '    {\n      "question": "Full question text?",\n      "options": ["Choice A", "Choice B", "Choice C", "Choice D"],\n' +
    '      "correctIndex": 0,\n      "explanation": "Why this answer is correct.",\n' +
    '      "difficulty": "easy",\n      "sourceUrl": "https://source-url.com"\n    }\n  ]\n}\n\n' +
    'difficulty values: "easy" | "medium" | "hard" | "bonus"\n' +
    'correctIndex: 0-based integer (0=A, 1=B, 2=C, 3=D)\n' +
    'Generate exactly 6 questions, one per assigned article.';
}

function parseQuestions(text) {
  // Strip markdown fences if present
  const bt = String.fromCharCode(96); const fence = bt+bt+bt; let clean = text.split(fence+'json').join('').split(fence).join('').trim();
  // Find JSON object
  const start = clean.indexOf('{');
  const end = clean.lastIndexOf('}');
  if (start === -1 || end === -1) throw new Error('No JSON found in response');
  clean = clean.slice(start, end+1);
  const parsed = JSON.parse(clean);

  // Surface stale article warnings to the admin UI
  if (parsed.staleWarning && parsed.staleArticles && parsed.staleArticles.length > 0) {
    const staleMsg = 'Warning: ' + parsed.staleArticles.length + ' article(s) were skipped as older than 24 hours: ' + parsed.staleArticles.join(', ');
    setStatus(staleMsg, 'error');
  }

  const questions = parsed.questions || [];
  return enforceQuizRules(questions);
}

function enforceQuizRules(questions) {
  // 1. Deduplicate ‚Äî only one question per sourceUrl
  const seenUrls = new Set();
  const deduped = questions.filter(q => {
    if (!q.sourceUrl || seenUrls.has(q.sourceUrl)) return false;
    seenUrls.add(q.sourceUrl);
    return true;
  });

  // 2. Shuffle correct answers so they're not all the same index
  const targetIndexes = [0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2];
  return deduped.map((q, i) => {
    const currentCorrect = q.options[q.correctIndex];
    const targetIdx = targetIndexes[i] !== undefined ? targetIndexes[i] : (i % 4);
    if (q.correctIndex === targetIdx) return q;
    const newOptions = [...q.options];
    const displaced = newOptions[targetIdx];
    newOptions[targetIdx] = currentCorrect;
    newOptions[q.correctIndex] = displaced;
    return { ...q, options: newOptions, correctIndex: targetIdx };
  });
}

function showDraftPreview(questions) {
  const diffMap = { easy:'easy', medium:'medium', hard:'hard', bonus:'bonus' };
  let html = '';
  questions.forEach((q, i) => {
    const diff = q.difficulty || (i < 4 ? 'easy' : i < 7 ? 'medium' : i < 10 ? 'hard' : 'bonus');
    const optLetters = ['A','B','C','D'];
    let optionsHtml = '<div class="q-options-grid">';
    q.options.forEach((opt, oi) => {
      optionsHtml += '<div class="q-option-row">' +
        '<input type="radio" name="correct-' + i + '" id="correct-' + i + '-' + oi + '" value="' + oi + '" ' + (oi === q.correctIndex ? 'checked' : '') + ' onchange="updateDraftCorrect(' + i + ', ' + oi + ')">' +
        '<label for="correct-' + i + '-' + oi + '">' + optLetters[oi] + '</label>' +
        '<input type="text" value="' + escHtml(opt) + '" oninput="updateDraftOption(' + i + ', ' + oi + ', this.value)" style="flex:1;">' +
        '</div>';
    });
    optionsHtml += '</div>';

    const sourceLink = q.sourceUrl ? '<a href="' + escHtml(q.sourceUrl) + '" target="_blank" style="font-family:monospace;font-size:11px;color:var(--blue);white-space:nowrap;">Open</a>' : '';
    const qLabel = i === 5 ? 'BONUS' : ('Q'+(i+1));
    const diffClass = diffMap[diff] || 'easy';
    html += '<div class="q-review-card" id="qcard-' + i + '">' +
      '<div class="q-meta">' +
        '<span><strong>' + qLabel + '</strong></span>' +
        '<span class="diff-label ' + diffClass + '" style="display:inline-block">' + diff.toUpperCase() + '</span>' +
        '<span style="margin-left:auto;display:flex;align-items:center;gap:10px;">' +
          '<label style="font-size:10px;color:var(--muted)">Move to position:</label>' +
          '<input type="number" min="1" max="11" style="width:44px;font-size:12px;padding:2px 4px;border:1px solid var(--border);border-radius:3px;" ' +
            'placeholder="' + (i+1) + '" onchange="reorderQuestion(' + i + ', parseInt(this.value)-1, this)">' +
          '<button onclick="replaceQuestion(' + i + ')" title="Replace with a new question" style="background:none;border:1px solid var(--gold);color:var(--gold,#b8860b);border-radius:3px;padding:2px 8px;font-size:11px;cursor:pointer;font-family:inherit;">‚Ü∫ Replace</button>' +
          '<button onclick="deleteQuestion(' + i + ')" title="Delete this question" style="background:none;border:1px solid var(--red);color:var(--red);border-radius:3px;padding:2px 8px;font-size:11px;cursor:pointer;font-family:inherit;">‚úï Delete</button>' +
        '</span>' +
      '</div>' +
      '<div class="q-edit-label">QUESTION</div>' +
      '<textarea oninput="updateDraftQuestion(' + i + ', this.value)">' + escHtml(q.question) + '</textarea>' +
      '<div class="q-edit-label">OPTIONS ‚Äî click radio button to mark correct answer</div>' +
      optionsHtml +
      '<div class="q-edit-label">EXPLANATION</div>' +
      '<input type="text" value="' + escHtml(q.explanation || '') + '" oninput="updateDraftExplanation(' + i + ', this.value)">' +
      '<div class="q-edit-label">SOURCE URL</div>' +
      '<div style="display:flex;align-items:center;gap:8px;">' +
        '<input type="text" value="' + escHtml(q.sourceUrl || '') + '" oninput="updateDraftSourceUrl(' + i + ', this.value)" style="flex:1;font-size:11px;">' +
        sourceLink +
      '</div>' +
    '</div>';
  });
  document.getElementById('q-preview-list').innerHTML = html;
  document.getElementById('preview-section').style.display = 'block';
}

// Live-edit helpers ‚Äî update the draft in localStorage as admin types
function deleteQuestion(idx) {
  const draft = getDraftQuiz();
  if (!draft || !draft.questions) return;
  if (!confirm('Delete question ' + (idx + 1) + '? You can regenerate to replace it.')) return;
  draft.questions.splice(idx, 1);
  const diffs = ['easy','easy','medium','medium','hard','bonus'];
  draft.questions.forEach((q, i) => { q.difficulty = diffs[i] || q.difficulty; });
  saveDraftQuiz(draft);
  showDraftPreview(draft.questions);
  setStatus('Question ' + (idx + 1) + ' deleted. ' + draft.questions.length + ' questions remaining.', 'info');
}

async function replaceQuestion(idx) {
  const draft = getDraftQuiz();
  if (!draft || !draft.questions) return;
  if (!confirm('Replace question ' + (idx + 1) + ' with a freshly generated one?')) return;

  setStatus('Generating replacement question‚Ä¶', 'info');

  // Get existing headlines to avoid duplicates
  const usedHeadlines = draft.questions.map(q => q.question);
  const diffs = ['easy','easy','medium','medium','hard','bonus'];
  const pts =   ['10',  '10',  '20',  '20',  '30',  '50'];
  const difficulty = diffs[idx] || 'medium';
  const points = pts[idx] || '20';

  // Build a short prompt for one replacement question from RSS
  let rssSnippet = '';
  try {
    const rssRes = await fetch('/api/rss');
    if (rssRes.ok) {
      const rssData = await rssRes.json();
      if (rssData.items) {
        // Filter out topics already in the draft
        const available = rssData.items.filter(item =>
          !draft.questions.some(q => q.sourceUrl === item.link)
        );
        rssSnippet = available.slice(0, 20).map((item, i) =>
          `ARTICLE ${i+1}:\nSOURCE: ${item.source}\nHEADLINE: ${item.title}\nSUMMARY: ${item.description}\nURL: ${item.link}`
        ).join('\n\n---\n\n');
      }
    }
  } catch(e) {}

  if (!rssSnippet) {
    setStatus('Could not load RSS articles for replacement.', 'error');
    return;
  }

  const prompt = 'You are writing ONE replacement question for a Baltimore local news quiz.\n\n' +
    'ALREADY USED TOPICS ‚Äî do not repeat these:\n' + usedHeadlines.join('\n') + '\n\n' +
    'AVAILABLE ARTICLES (pick the single most newsworthy one not already covered):\n\n' + rssSnippet + '\n\n' +
    'QUESTION FOCUS RULES:\n' +
    '- Ask about the WHO or WHAT that makes the story newsworthy, NOT dollar amounts, durations, or counts\n' +
    '- Wrong answers must be the same category as the correct answer (same type of company, person, place)\n' +
    '- Skip routine sports transactions, minor arts items, individual crime stories, and weather unless historic\n\n' +
    'Write exactly ONE question at difficulty: ' + difficulty + ' (' + points + ' pts).\n\n' +
    'OUTPUT: Respond with ONLY valid JSON. No preamble, no markdown.\n' +
    '{"question":"...","options":["A","B","C","D"],"correctIndex":0,"explanation":"...","difficulty":"' + difficulty + '","sourceUrl":"..."}';

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      signal: controller.signal,
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 600,
        messages: [{ role: 'user', content: prompt }]
      })
    });
    clearTimeout(timeout);
    const data = await res.json();
    const text = (data.content || []).map(c => c.text || '').join('').trim();
    const clean = text.replace(/```json|```/g, '').trim();
    const newQ = JSON.parse(clean);
    newQ.difficulty = difficulty;

    draft.questions[idx] = newQ;
    saveDraftQuiz(draft);
    showDraftPreview(draft.questions);
    setStatus('Question ' + (idx + 1) + ' replaced!', 'success');
  } catch(e) {
    setStatus('Replacement failed ‚Äî try again. (' + e.message + ')', 'error');
  }
}

function reorderQuestion(fromIdx, toIdx, inputEl) {
  const draft = getDraftQuiz();
  if (!draft || !draft.questions) return;
  const qs = draft.questions;
  if (toIdx < 0 || toIdx >= qs.length || toIdx === fromIdx) {
    inputEl.value = '';
    return;
  }
  // Move question from fromIdx to toIdx
  const [moved] = qs.splice(fromIdx, 1);
  qs.splice(toIdx, 0, moved);
  // Re-apply difficulty labels based on new positions
  const diffs = ['easy','easy','medium','medium','hard','bonus'];
  qs.forEach((q, i) => { q.difficulty = diffs[i] || q.difficulty; });
  draft.questions = qs;
  saveDraftQuiz(draft);
  showDraftPreview(qs);
  setStatus('Question moved to position ' + (toIdx+1) + '.', 'info');
}

function reorderQuestion(fromIdx, toIdx, inputEl) {
  const draft = getDraftQuiz();
  if (!draft || !draft.questions) return;
  const qs = draft.questions;
  if (isNaN(toIdx) || toIdx < 0 || toIdx >= qs.length || toIdx === fromIdx) {
    inputEl.value = '';
    return;
  }
  const [moved] = qs.splice(fromIdx, 1);
  qs.splice(toIdx, 0, moved);
  // Re-apply difficulty labels based on new positions
  const diffs = ['easy','easy','medium','medium','hard','bonus'];
  qs.forEach((q, i) => { q.difficulty = diffs[i] || q.difficulty; });
  draft.questions = qs;
  saveDraftQuiz(draft);
  showDraftPreview(qs);
  setStatus('Question moved to position ' + (toIdx + 1) + '.', 'info');
}

function updateDraftQuestion(i, val) {
  const draft = getDraftQuiz();
  if (draft && draft.questions[i]) { draft.questions[i].question = val; saveDraftQuiz(draft); }
}
function updateDraftOption(i, oi, val) {
  const draft = getDraftQuiz();
  if (draft && draft.questions[i]) { draft.questions[i].options[oi] = val; saveDraftQuiz(draft); }
}
function updateDraftCorrect(i, oi) {
  const draft = getDraftQuiz();
  if (draft && draft.questions[i]) { draft.questions[i].correctIndex = oi; saveDraftQuiz(draft); }
}
function updateDraftExplanation(i, val) {
  const draft = getDraftQuiz();
  if (draft && draft.questions[i]) { draft.questions[i].explanation = val; saveDraftQuiz(draft); }
}
function updateDraftSourceUrl(i, val) {
  const draft = getDraftQuiz();
  if (draft && draft.questions[i]) { draft.questions[i].sourceUrl = val; saveDraftQuiz(draft); }
}

function publishQuestions() {
  const draft = getDraftQuiz();
  if (!draft || !draft.questions) { setStatus('No draft to publish.', 'error'); return; }
  if (draft.questions.length < 6) { setStatus('Draft has only ' + draft.questions.length + ' unique questions (need 6) ‚Äî please regenerate.', 'error'); return; }

  saveTodayQuiz(draft);
  addToArchive(draft.questions);
  clearDraftQuiz();
  // Also persist to server so quiz survives across browsers/devices
  fetch('/api/quiz', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ date: todayStr(), quiz: draft })
  }).catch(e => console.warn('Could not save quiz to server:', e.message));
  setStatus('Quiz published for ' + todayStr() + '! Players can now play.', 'success');
  document.getElementById('preview-section').style.display = 'none';
  refreshAdminPreviews();
}

function discardDraft() {
  clearDraftQuiz();
  document.getElementById('preview-section').style.display = 'none';
  document.getElementById('q-preview-list').innerHTML = '';
  setStatus('Draft discarded.', 'info');
}

function clearArchive() {
  if (!confirm('Clear the entire question archive? Past questions may be regenerated.')) return;
  lsSet('dnq_archive', []);
  refreshAdminPreviews();
}

function resetDailyScores() {
  if (!confirm('Reset all daily scores for today? All-time scores will be preserved.')) return;
  const players = getPlayers();
  Object.values(players).forEach(p => {
    if (p.dailyScores) delete p.dailyScores[state.todayKey];
  });
  savePlayers(players);
  setStatus('Daily scores reset.', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Enter key for registration
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('screen-register').classList.contains('active')) {
    registerPlayer();
  }
});
</script>
</body>
</html>
